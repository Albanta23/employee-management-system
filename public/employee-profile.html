<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mi Perfil - Gesti√≥n RH</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .profile-header {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 2rem;
            position: relative;
        }

        .profile-avatar-container {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid var(--primary);
            flex-shrink: 0;
        }

        .profile-avatar {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-edit-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.6);
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .avatar-edit-overlay span {
            font-size: 1.25rem;
            color: white;
        }

        .profile-info h2 {
            margin: 0 0 0.5rem 0;
            font-size: 1.5rem;
        }

        .profile-info p {
            margin: 0;
            color: var(--text-muted);
        }

        .status-active {
            display: inline-block;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
        }

        .info-group {
            background: rgba(30, 41, 59, 0.5);
            border-radius: var(--radius-lg);
            padding: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .info-row {
            display: block;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            color: var(--text-muted);
            font-size: 0.8rem;
            display: block;
            margin-bottom: 0.25rem;
        }

        .info-value {
            font-weight: 500;
            word-break: break-all;
            overflow-wrap: anywhere;
            display: block;
            font-size: 0.9rem;
        }

        .info-value input {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            padding: 0.5rem;
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.85rem;
            width: 100%;
            box-sizing: border-box;
            word-break: break-all;
            overflow-wrap: anywhere;
        }

        @media (max-width: 400px) {
            .info-value input {
                font-size: 0.8rem;
            }
        }

        .info-value input:focus {
            border-color: var(--primary);
            background: rgba(0, 0, 0, 0.2);
            outline: none;
        }
    </style>
</head>

<body style="background: #0f172a; padding: 1.5rem; padding-bottom: 80px;">
    <div id="alert-container"></div>

    <a href="employee-dashboard.html"
        style="color: var(--text-muted); text-decoration: none; display: block; margin-bottom: 1.5rem;">‚¨ÖÔ∏è Volver</a>

    <div class="profile-header">
        <label class="profile-avatar-container" for="avatar-input">
            <img src="https://ui-avatars.com/api/?name=User&background=6366f1&color=fff" id="profile-img"
                class="profile-avatar" alt="Avatar">
            <div class="avatar-edit-overlay">
                <span>üì∑</span>
            </div>
            <input type="file" id="avatar-input" accept="image/*" style="display: none;">
        </label>
        <div class="profile-info">
            <h2 id="display-name">Cargando...</h2>
            <p id="display-position">...</p>
            <span class="status-active">‚óè Activo</span>
        </div>
    </div>

    <form id="profile-form">
        <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--primary-light);">Informaci√≥n Personal</h3>
        <div class="info-group">
            <div class="info-row">
                <span class="info-label">DNI / NIE</span>
                <span class="info-value" id="display-dni">...</span>
            </div>
            <div class="info-row">
                <span class="info-label">Email</span>
                <div class="info-value">
                    <input type="email" id="email" required>
                </div>
            </div>
            <div class="info-row">
                <span class="info-label">Tel√©fono</span>
                <div class="info-value">
                    <input type="tel" id="phone" required>
                </div>
            </div>
            <div class="info-row">
                <span class="info-label">Ubicaci√≥n</span>
                <span class="info-value" id="display-location">...</span>
            </div>
        </div>

        <h3 style="font-size: 1.1rem; margin: 1.75rem 0 1rem; color: var(--primary-light);">Mi horario</h3>
        <div class="info-group">
            <div class="info-row">
                <span class="info-label">Activar control por horario</span>
                <div class="info-value">
                    <label style="display:flex; align-items:center; gap:0.5rem;">
                        <input type="checkbox" id="schedule_enabled">
                        <span style="font-size: 0.9rem;">Quiero que el sistema valide mis fichajes</span>
                    </label>
                </div>
            </div>

            <div class="info-row">
                <span class="info-label">D√≠as laborables</span>
                <div class="info-value" style="display:flex; gap:0.5rem; flex-wrap: wrap;">
                    <label style="display:flex; align-items:center; gap:0.25rem;"><input type="checkbox" class="schedule-day" value="1">L</label>
                    <label style="display:flex; align-items:center; gap:0.25rem;"><input type="checkbox" class="schedule-day" value="2">M</label>
                    <label style="display:flex; align-items:center; gap:0.25rem;"><input type="checkbox" class="schedule-day" value="3">X</label>
                    <label style="display:flex; align-items:center; gap:0.25rem;"><input type="checkbox" class="schedule-day" value="4">J</label>
                    <label style="display:flex; align-items:center; gap:0.25rem;"><input type="checkbox" class="schedule-day" value="5">V</label>
                    <label style="display:flex; align-items:center; gap:0.25rem;"><input type="checkbox" class="schedule-day" value="6">S</label>
                    <label style="display:flex; align-items:center; gap:0.25rem;"><input type="checkbox" class="schedule-day" value="0">D</label>
                </div>
            </div>

            <div class="info-row">
                <span class="info-label">Entrada (HH:mm)</span>
                <div class="info-value">
                    <input type="time" id="schedule_start" required>
                </div>
            </div>

            <div class="info-row">
                <span class="info-label">Salida (HH:mm)</span>
                <div class="info-value">
                    <input type="time" id="schedule_end" required>
                </div>
            </div>

            <div class="info-row">
                <span class="info-label">Descanso (opcional)</span>
                <div class="info-value" style="display:grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                    <input type="time" id="schedule_break_start" placeholder="Inicio">
                    <input type="time" id="schedule_break_end" placeholder="Fin">
                </div>
            </div>

            <div class="info-row">
                <span class="info-label">Tolerancia (minutos)</span>
                <div class="info-value">
                    <input type="number" id="schedule_tolerance" min="0" max="180" step="1" required>
                </div>
            </div>

            <div class="info-row">
                <span class="info-label">S√°bado (opcional)</span>
                <div class="info-value" style="display:grid; gap:0.5rem;">
                    <label style="display:flex; align-items:center; gap:0.5rem;">
                        <input type="checkbox" id="schedule_sat_enabled">
                        <span style="font-size: 0.9rem;">Horario especial solo los s√°bados</span>
                    </label>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <input type="time" id="schedule_sat_start" placeholder="Entrada">
                        <input type="time" id="schedule_sat_end" placeholder="Salida">
                    </div>
                    <small style="color: var(--text-muted);">Ejemplo: 09:00‚Äì14:00 (ma√±ana)</small>
                </div>
            </div>

            <div class="info-row">
                <span class="info-label">Excepciones (puntuales)</span>
                <div class="info-value">
                    <div id="schedule-exceptions" style="display:grid; gap: 0.5rem;"></div>
                    <button type="button" id="add-exception" class="btn btn-secondary" style="margin-top: 0.5rem; width: 100%;">
                        ‚ûï A√±adir excepci√≥n
                    </button>
                    <small style="color: var(--text-muted);">√ötil para ‚Äúsolo ma√±ana‚Äù un d√≠a concreto o trabajar un festivo.</small>
                </div>
            </div>
        </div>

        <button type="submit" class="btn btn-primary" style="width: 100%; padding: 1rem; margin-bottom: 1rem;">
            Guardar Cambios
        </button>
    </form>

    <a href="change-password.html" class="btn btn-secondary"
        style="display: block; width: 100%; padding: 1rem; text-align: center; box-sizing: border-box; text-decoration: none; background: rgba(255,255,255,0.05);">
        üîí Cambiar Contrase√±a
    </a>

    <div
        style="margin-top: 2rem; padding: 1rem; background: rgba(99, 102, 241, 0.1); border-radius: 8px; font-size: 0.85rem; color: #a5b4fc;">
        ‚ÑπÔ∏è <strong>Nota sobre la foto:</strong> Tu foto de perfil se guarda √∫nicamente en este dispositivo para respetar
        los l√≠mites de espacio del servidor.
    </div>

    <nav class="bottom-nav"
        style="position: fixed; bottom: 0; left: 0; right: 0; background: rgba(30, 41, 59, 0.9); backdrop-filter: blur(10px); display: flex; justify-content: space-around; padding: 1rem; border-top: 1px solid rgba(255, 255, 255, 0.1);">
        <a href="employee-dashboard.html"
            style="text-decoration: none; color: var(--text-muted); text-align: center;">üè†<br><small>Inicio</small></a>
        <a href="employee-vacations.html"
            style="text-decoration: none; color: var(--text-muted); text-align: center;">üèñÔ∏è<br><small>Vacas</small></a>
        <a href="employee-reports.html"
            style="text-decoration: none; color: var(--text-muted); text-align: center;">üìã<br><small>Informes</small></a>
        <a href="employee-profile.html"
            style="text-decoration: none; color: var(--primary-light); text-align: center;">üë§<br><small>Perfil</small></a>
    </nav>

    <script src="js/api.js"></script>
    <script src="js/branding.js"></script>
    <script>
        const user = getUser();
        if (!user || user.role !== 'employee') window.location.href = 'index.html';

        // Cargar datos
        async function loadProfile() {
            try {
                // Usar la ruta /me que permite a empleados acceder a su propio perfil
                const employeeData = await employeesAPI.getMe();
                if (!employeeData) throw new Error('No se pudo cargar el perfil');

                document.getElementById('display-name').textContent = employeeData.full_name;
                document.getElementById('display-position').textContent = employeeData.position || 'Empleado';
                document.getElementById('display-dni').textContent = employeeData.dni;
                document.getElementById('display-location').textContent = employeeData.location || '-';

                document.getElementById('email').value = employeeData.email || '';
                document.getElementById('phone').value = employeeData.phone || '';

                // Cargar horario
                const ws = employeeData.work_schedule || {};
                document.getElementById('schedule_enabled').checked = ws.enabled === true;
                document.getElementById('schedule_start').value = ws.start_time || '09:00';
                document.getElementById('schedule_end').value = ws.end_time || '18:00';
                document.getElementById('schedule_break_start').value = ws.break_start || '';
                document.getElementById('schedule_break_end').value = ws.break_end || '';
                document.getElementById('schedule_tolerance').value = (ws.tolerance_minutes ?? 10);

                // S√°bado (override)
                const dowOverrides = ws.day_overrides || {};
                const sat = dowOverrides['6'] || dowOverrides[6] || null;
                document.getElementById('schedule_sat_enabled').checked = Boolean(sat && sat.enabled === true);
                document.getElementById('schedule_sat_start').value = (sat && sat.start_time) ? sat.start_time : '';
                document.getElementById('schedule_sat_end').value = (sat && sat.end_time) ? sat.end_time : '';

                // Excepciones por fecha
                scheduleDateOverrides = Array.isArray(ws.date_overrides) ? ws.date_overrides.slice() : [];
                renderDateOverrides();

                const days = Array.isArray(ws.days_of_week) ? ws.days_of_week.map(Number) : [1, 2, 3, 4, 5];
                document.querySelectorAll('.schedule-day').forEach(cb => {
                    cb.checked = days.includes(Number(cb.value));
                });

                // Cargar avatar local
                loadLocalAvatar(employeeData.full_name);

            } catch (error) {
                console.error(error);
                showAlert('Error al cargar datos del perfil', 'error');
            }
        }

        // Manejo de Avatar Local
        function loadLocalAvatar(name) {
            const storedAvatar = localStorage.getItem(`avatar_${user.employee_id}`);
            const imgEl = document.getElementById('profile-img');

            if (storedAvatar) {
                imgEl.src = storedAvatar;
            } else {
                // Avatar por defecto con iniciales
                imgEl.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=6366f1&color=fff&size=200`;
            }
        }

        document.getElementById('avatar-input').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            if (file.size > 2 * 1024 * 1024) {
                return showAlert('La imagen es demasiado grande (M√°x 2MB)', 'warning');
            }

            const reader = new FileReader();
            reader.onload = function (event) {
                // Resize image logic here if needed, but for now simple base64 storage
                // For better performance, we should ideally use a canvas to resize to 200x200
                resizeImage(event.target.result, 200, 200, (resizedBase64) => {
                    localStorage.setItem(`avatar_${user.employee_id}`, resizedBase64);
                    document.getElementById('profile-img').src = resizedBase64;
                    showAlert('Foto de perfil actualizada (Local)', 'success');
                });
            };
            reader.readAsDataURL(file);
        });

        function resizeImage(base64Str, maxWidth, maxHeight, callback) {
            const img = new Image();
            img.src = base64Str;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;

                if (width > height) {
                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }
                } else {
                    if (height > maxHeight) {
                        width *= maxHeight / height;
                        height = maxHeight;
                    }
                }
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                callback(canvas.toDataURL('image/jpeg', 0.7)); // Compress quality 0.7
            };
        }

        // Guardar cambios
        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const days = Array.from(document.querySelectorAll('.schedule-day'))
                .filter(cb => cb.checked)
                .map(cb => Number(cb.value));

            const day_overrides = {};
            if (document.getElementById('schedule_sat_enabled').checked) {
                day_overrides['6'] = {
                    enabled: true,
                    start_time: document.getElementById('schedule_sat_start').value,
                    end_time: document.getElementById('schedule_sat_end').value,
                    break_start: '',
                    break_end: ''
                };
            }

            const work_schedule = {
                enabled: document.getElementById('schedule_enabled').checked,
                days_of_week: days,
                start_time: document.getElementById('schedule_start').value,
                end_time: document.getElementById('schedule_end').value,
                break_start: document.getElementById('schedule_break_start').value || '',
                break_end: document.getElementById('schedule_break_end').value || '',
                tolerance_minutes: Number(document.getElementById('schedule_tolerance').value),
                day_overrides,
                date_overrides: scheduleDateOverrides
            };

            const updatedData = {
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                work_schedule
            };

            const res = await employeesAPI.update(user.employee_id, updatedData);
            if (res) {
                showAlert('Perfil actualizado correctamente', 'success');
            }
        });

        loadProfile();

        // Excepciones por fecha (UI)
        let scheduleDateOverrides = [];

        function renderDateOverrides() {
            const container = document.getElementById('schedule-exceptions');
            if (!container) return;

            if (!scheduleDateOverrides || scheduleDateOverrides.length === 0) {
                container.innerHTML = '<div style="color: var(--text-muted); font-size: 0.9rem;">Sin excepciones configuradas</div>';
                return;
            }

            // Ordenar por fecha
            const sorted = scheduleDateOverrides.slice().sort((a, b) => String(a.date || '').localeCompare(String(b.date || '')));

            container.innerHTML = sorted.map((it, idx) => {
                const date = it.date || '';
                const enabled = it.enabled !== false;
                const start = it.start_time || '';
                const end = it.end_time || '';
                const bs = it.break_start || '';
                const be = it.break_end || '';

                return `
                    <div data-idx="${idx}" style="padding: 0.75rem; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; display: grid; gap: 0.5rem;">
                        <div style="display:grid; grid-template-columns: 1fr auto; gap: 0.5rem; align-items:center;">
                            <input type="date" value="${date}" class="ex-date" style="width: 100%;">
                            <button type="button" class="btn btn-secondary ex-del" style="padding: 0.5rem 0.75rem;">üóëÔ∏è</button>
                        </div>
                        <label style="display:flex; align-items:center; gap:0.5rem;">
                            <input type="checkbox" class="ex-enabled" ${enabled ? 'checked' : ''}>
                            <span style="font-size: 0.9rem;">D√≠a laborable</span>
                        </label>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <input type="time" value="${start}" class="ex-start" placeholder="Entrada">
                            <input type="time" value="${end}" class="ex-end" placeholder="Salida">
                        </div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                            <input type="time" value="${bs}" class="ex-bs" placeholder="Descanso inicio">
                            <input type="time" value="${be}" class="ex-be" placeholder="Descanso fin">
                        </div>
                    </div>
                `;
            }).join('');

            // Re-map para mantener √≠ndices coherentes con el array original
            const rows = Array.from(container.querySelectorAll('[data-idx]'));
            rows.forEach((row) => {
                const dateEl = row.querySelector('.ex-date');
                const enabledEl = row.querySelector('.ex-enabled');
                const startEl = row.querySelector('.ex-start');
                const endEl = row.querySelector('.ex-end');
                const bsEl = row.querySelector('.ex-bs');
                const beEl = row.querySelector('.ex-be');
                const delEl = row.querySelector('.ex-del');

                function sync() {
                    const date = dateEl.value;
                    // localizar el elemento por fecha si existe, si no por posici√≥n
                    const idx = scheduleDateOverrides.findIndex(x => x && x.date === date);
                    const targetIndex = idx >= 0 ? idx : scheduleDateOverrides.findIndex(x => x && x.date === (row.querySelector('.ex-date')?.defaultValue || ''));
                    const i = targetIndex >= 0 ? targetIndex : scheduleDateOverrides.findIndex(x => x && x.date === date) ;
                    const target = i >= 0 ? scheduleDateOverrides[i] : null;

                    // Si el usuario cambia la fecha, actualizamos el registro (simple)
                    const next = {
                        date,
                        enabled: enabledEl.checked,
                        start_time: startEl.value,
                        end_time: endEl.value,
                        break_start: bsEl.value || '',
                        break_end: beEl.value || ''
                    };

                    if (target) {
                        Object.assign(target, next);
                    } else {
                        scheduleDateOverrides.push(next);
                    }
                }

                [dateEl, enabledEl, startEl, endEl, bsEl, beEl].forEach(el => {
                    if (!el) return;
                    el.addEventListener('change', sync);
                });

                if (delEl) {
                    delEl.addEventListener('click', () => {
                        const date = dateEl.value;
                        scheduleDateOverrides = scheduleDateOverrides.filter(x => x && x.date !== date);
                        renderDateOverrides();
                    });
                }
            });
        }

        document.getElementById('add-exception')?.addEventListener('click', () => {
            const today = new Date().toISOString().slice(0, 10);
            scheduleDateOverrides.push({
                date: today,
                enabled: true,
                start_time: document.getElementById('schedule_start').value || '09:00',
                end_time: document.getElementById('schedule_end').value || '18:00',
                break_start: document.getElementById('schedule_break_start').value || '',
                break_end: document.getElementById('schedule_break_end').value || ''
            });
            renderDateOverrides();
        });
    </script>
</body>

</html>