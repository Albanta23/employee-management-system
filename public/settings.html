<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuraci√≥n - Sistema de Gesti√≥n</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .settings-section {
            padding-bottom: 2rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .settings-section:last-child {
            border-bottom: none;
        }

        .logo-preview {
            width: 150px;
            height: 150px;
            border-radius: var(--radius-md);
            background: rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin-bottom: 1rem;
            border: 2px dashed rgba(255, 255, 255, 0.1);
        }

        .logo-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            font-size: 100px;
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <span id="app-logo-icon">üë•</span>
                <span id="app-logo-text">Gesti√≥n RH</span>
            </div>
        </div>

        <ul class="sidebar-menu">
            <li class="menu-item"><a href="dashboard.html" class="menu-link"><span>üìä</span> Dashboard</a></li>
            <li class="menu-item"><a href="reports.html" class="menu-link"><span>üìà</span> Reportes</a></li>
            <li class="menu-item"><a href="employees.html" class="menu-link"><span>üë§</span> Trabajadores</a></li>
            <li class="menu-item"><a href="attendance-admin.html" class="menu-link"><span>üïí</span> Control Horario</a>
            </li>
            <li class="menu-item"><a href="vacations.html" class="menu-link"><span>üèñÔ∏è</span> Vacaciones</a></li>
            <li class="menu-item"><a href="absences.html" class="menu-link"><span>üè•</span> Bajas M√©dicas</a></li>
            <li class="menu-item"><a href="permissions.html" class="menu-link"><span>üìÑ</span> Ausencias y Permisos</a>
            </li>
            <li class="menu-item"><a href="settings.html" class="menu-link active"><span>‚öôÔ∏è</span> Configuraci√≥n</a>
            </li>
        </ul>

        <div style="margin-top: auto; padding-top: var(--spacing-xl);">
            <button onclick="logout()" class="btn btn-secondary" style="width: 100%;">
                üö™ Cerrar Sesi√≥n
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="card fade-in">
            <div class="card-header">
                <h1 class="card-title" style="margin: 0; font-size: 1.5rem;">Configuraci√≥n del Sistema</h1>
            </div>

            <div id="alert-container"></div>

            <!-- Datos de la Empresa -->
            <div class="settings-section" id="companySection">
                <h2 style="margin-bottom: 1.5rem; color: var(--primary-light);">üè¢ Datos de la Empresa</h2>
                <div class="grid grid-cols-2">
                    <div>
                        <div class="form-group">
                            <label class="form-label">Logo de la Empresa</label>
                            <div class="logo-preview" id="logoPreview">
                                <span style="color: var(--text-muted);">Sin Logo</span>
                            </div>
                            <div class="file-input-wrapper">
                                <button class="btn btn-secondary">üìÇ Seleccionar Archivo</button>
                                <input type="file" id="logoInput" accept="image/*" onchange="handleLogoUpload(this)">
                            </div>
                            <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">Recomendado:
                                500x500px, PNG transparente.</p>
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label class="form-label">Nombre de la Empresa</label>
                            <input type="text" id="companyName" class="form-control" placeholder="Ej. Mi Empresa S.L.">
                        </div>
                        <div class="form-group">
                            <label class="form-label">CIF / NIF</label>
                            <input type="text" id="companyCif" class="form-control" placeholder="Ej. B12345678">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Direcci√≥n Fiscal</label>
                            <textarea id="companyAddress" class="form-control" rows="3"
                                placeholder="Calle, n√∫mero, CP, ciudad..."></textarea>
                        </div>
                    </div>
                </div>
                <button onclick="saveCompanySettings()" class="btn btn-primary" style="margin-top: 1rem;">üíæ Guardar
                    Datos Empresa</button>
            </div>

            <!-- Reglas de Solapamiento -->
            <div class="settings-section" id="overlapRulesSection">
                <h2 style="margin-bottom: 1.5rem; color: var(--primary-light);">‚õî Reglas de solapamiento</h2>
                <p style="color: var(--text-muted); margin-bottom: 1rem;">
                    Define cu√°ndo el sistema debe bloquear solicitudes que se solapan en fechas para un mismo empleado.
                    Estas reglas aplican a Vacaciones, Permisos y Bajas.
                </p>

                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label">Aplicar a *</label>
                    <select id="overlapTarget" class="form-select" onchange="loadOverlapRules()">
                        <option value="__global__">Global (todas las tiendas)</option>
                    </select>
                    <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.35rem;">
                        Selecciona una tienda/ubicaci√≥n (coincide con <b>Empleado ‚Üí ubicaci√≥n</b>) para definir reglas espec√≠ficas.
                    </p>
                </div>

                <div class="grid grid-cols-2" style="gap: .75rem;">
                    <label class="form-label" style="display:flex; align-items:center; gap: .5rem; margin: 0; font-weight: 500;">
                        <input type="checkbox" id="ov_vac_vac" checked> Bloquear Vacaciones con Vacaciones
                    </label>
                    <label class="form-label" style="display:flex; align-items:center; gap: .5rem; margin: 0; font-weight: 500;">
                        <input type="checkbox" id="ov_vac_perm" checked> Bloquear Vacaciones con Permisos
                    </label>
                    <label class="form-label" style="display:flex; align-items:center; gap: .5rem; margin: 0; font-weight: 500;">
                        <input type="checkbox" id="ov_vac_abs" checked> Bloquear Vacaciones con Bajas
                    </label>

                    <label class="form-label" style="display:flex; align-items:center; gap: .5rem; margin: 0; font-weight: 500;">
                        <input type="checkbox" id="ov_perm_perm" checked> Bloquear Permisos con Permisos
                    </label>
                    <label class="form-label" style="display:flex; align-items:center; gap: .5rem; margin: 0; font-weight: 500;">
                        <input type="checkbox" id="ov_perm_abs" checked> Bloquear Permisos con Bajas
                    </label>
                    <label class="form-label" style="display:flex; align-items:center; gap: .5rem; margin: 0; font-weight: 500;">
                        <input type="checkbox" id="ov_abs_abs" checked> Bloquear Bajas con Bajas
                    </label>
                </div>

                <button onclick="saveOverlapRules()" class="btn btn-primary" style="margin-top: 1rem;">üíæ Guardar reglas de solapamiento</button>
            </div>

            <!-- Saldo anual avanzado (prorrateo + carryover) -->
            <div class="settings-section" id="vacationPolicySection">
                <h2 style="margin-bottom: 1.5rem; color: var(--primary-light);">üìÜ Saldo anual avanzado</h2>
                <p style="color: var(--text-muted); margin-bottom: 1rem;">
                    Configura el prorrateo por fecha de alta/baja y el arrastre (carryover) de d√≠as del a√±o anterior.
                    Por defecto est√° desactivado para mantener el saldo cl√°sico.
                </p>

                <div class="grid grid-cols-2" style="gap: 1rem;">
                    <div class="form-group" style="margin: 0;">
                        <label class="form-label" style="display:flex; align-items:center; gap: .5rem; margin-bottom: .5rem;">
                            <input type="checkbox" id="vpProrationEnabled" style="transform: scale(1.1);">
                            Activar prorrateo anual
                        </label>
                        <p style="font-size: 0.8rem; color: var(--text-muted);">Usa <b>Empleado ‚Üí fecha de alta/baja</b> para calcular las asignadas.</p>
                    </div>

                    <div class="form-group" style="margin: 0;">
                        <label class="form-label">Redondeo del prorrateo</label>
                        <input type="number" id="vpProrationRounding" class="form-control" min="0.1" step="0.1" value="0.5">
                        <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.35rem;">Ej: 0.5 = medios d√≠as.</p>
                    </div>

                    <div class="form-group" style="margin: 0;">
                        <label class="form-label" style="display:flex; align-items:center; gap: .5rem; margin-bottom: .5rem;">
                            <input type="checkbox" id="vpCarryoverEnabled" style="transform: scale(1.1);">
                            Activar arrastre (carryover)
                        </label>
                        <p style="font-size: 0.8rem; color: var(--text-muted);">A√±ade d√≠as del a√±o anterior (no disfrutados) hasta un m√°ximo.</p>
                    </div>

                    <div class="form-group" style="margin: 0;">
                        <label class="form-label">M√°ximo arrastre (d√≠as)</label>
                        <input type="number" id="vpCarryoverMax" class="form-control" min="0" step="0.5" value="0">
                    </div>

                    <div class="form-group" style="margin: 0;">
                        <label class="form-label">Caducidad arrastre (MM-DD)</label>
                        <input type="text" id="vpCarryoverExpiry" class="form-control" placeholder="03-31" value="03-31">
                        <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.35rem;">Se informa en la API; no afecta a solapes.</p>
                    </div>
                </div>

                <button onclick="saveVacationPolicy()" class="btn btn-primary" style="margin-top: 1rem;">üíæ Guardar saldo anual avanzado</button>
            </div>

            <!-- PINs de Regularizaci√≥n -->
            <div class="settings-section" id="regularizationPinsSection">
                <h2 style="margin-bottom: 1.5rem; color: var(--primary-light);">üî¢ PINs de Regularizaci√≥n</h2>
                <p style="color: var(--text-muted); margin-bottom: 1rem;">
                    C√≥digos de 4 d√≠gitos para acceder al panel de regularizaci√≥n de fichajes. Este panel permite ajustar manualmente los registros de asistencia.
                </p>
                <div class="grid grid-cols-2">
                    <div class="form-group">
                        <label class="form-label">PIN Administrador</label>
                        <input type="text" id="regularizationAdminPin" class="form-control" placeholder="1234" maxlength="4" pattern="[0-9]{4}" inputmode="numeric">
                        <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.35rem;">4 d√≠gitos num√©ricos. Por defecto: 1234</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">PIN Coordinador</label>
                        <input type="text" id="regularizationCoordinatorPin" class="form-control" placeholder="5678" maxlength="4" pattern="[0-9]{4}" inputmode="numeric">
                        <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.35rem;">4 d√≠gitos num√©ricos. Por defecto: 5678</p>
                    </div>
                </div>
                <button onclick="saveRegularizationPins()" class="btn btn-primary" style="margin-top: 1rem;">üíæ Guardar PINs</button>
            </div>

            <!-- Gesti√≥n de Administrador -->
            <div class="settings-section" id="adminSection">
                <h2 style="margin-bottom: 1.5rem; color: var(--primary-light);">üõ°Ô∏è Gesti√≥n de Administrador</h2>
                <p
                    style="color: var(--text-muted); margin-bottom: 1.5rem; background: rgba(245, 158, 11, 0.1); padding: 1rem; border-radius: var(--radius-md); border-left: 3px solid #f59e0b;">
                    ‚ö†Ô∏è Aqu√≠ puedes cambiar las credenciales de acceso del administrador. Aseg√∫rate de recordar los
                    nuevos datos.
                </p>
                <div class="grid grid-cols-2">
                    <div class="form-group">
                        <label class="form-label">Nuevo Usuario (ID)</label>
                        <input type="text" id="adminUser" class="form-control" placeholder="Nuevo usuario admin">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nueva Contrase√±a (C√≥digo)</label>
                        <input type="password" id="adminPass" class="form-control" placeholder="Nueva contrase√±a">
                    </div>
                </div>
                <button onclick="updateAdminCredentials()" class="btn btn-secondary"
                    style="border-color: var(--warning); color: var(--warning);">üîê Actualizar Credenciales</button>
            </div>

            <!-- Coordinador de Tiendas -->
            <div class="settings-section" id="coordinatorSection">
                <h2 style="margin-bottom: 1.5rem; color: var(--primary-light);">üßë‚Äçüíº Coordinador de Tiendas</h2>
                <p style="color: var(--text-muted); margin-bottom: 1rem;">
                    Este perfil tiene acceso similar al administrador, pero √∫nicamente a empleados de tienda y sus datos.
                    El alcance (qu√© se considera tienda) y las secciones visibles se configuran aqu√≠.
                </p>

                <div class="form-group" style="margin-bottom: 1rem;">
                    <label class="form-label" style="display:flex; align-items:center; gap: .5rem;">
                        <input type="checkbox" id="coordinatorEnabled" style="transform: scale(1.1);">
                        Activar perfil de Coordinador de Tiendas
                    </label>
                </div>

                <div class="grid grid-cols-2">
                    <div class="form-group">
                        <label class="form-label">Usuario Coordinador</label>
                        <input type="text" id="coordinatorUsername" class="form-control" placeholder="usuario.coordinador">
                        <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.35rem;">Si lo cambias, se actualizar√° la cuenta del coordinador.</p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contrase√±a Coordinador</label>
                        <input type="password" id="coordinatorPassword" class="form-control" placeholder="(dejar en blanco para no cambiar)">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Ubicaciones consideradas TIENDA</label>
                    <textarea id="storeLocations" class="form-control" rows="5" placeholder="(Opcional) Una ubicaci√≥n por l√≠nea. Si se deja vac√≠o: TIENDA = todo lo que NO sea F√ÅBRICA."></textarea>
                    <p style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.35rem;">
                        Si completas esta lista, el coordinador solo ver√° esas ubicaciones. Si la dejas vac√≠a, el sistema considerar√° F√ÅBRICA toda ubicaci√≥n cuyo texto contenga ‚Äúfabrica/f√°brica‚Äù, y TIENDA el resto.
                    </p>
                </div>

                <div class="form-group" style="margin-top: 1rem;">
                    <label class="form-label">Secciones a las que tendr√° acceso</label>
                    <div class="grid grid-cols-2" style="gap: .75rem;">
                        <label class="form-label" style="display:flex; align-items:center; gap: .5rem; margin: 0; font-weight: 500;">
                            <input type="checkbox" id="accessEmployees" checked> Trabajadores
                        </label>
                        <label class="form-label" style="display:flex; align-items:center; gap: .5rem; margin: 0; font-weight: 500;">
                            <input type="checkbox" id="accessAttendance" checked> Control Horario
                        </label>
                        <label class="form-label" style="display:flex; align-items:center; gap: .5rem; margin: 0; font-weight: 500;">
                            <input type="checkbox" id="accessVacations" checked> Vacaciones
                        </label>
                        <label class="form-label" style="display:flex; align-items:center; gap: .5rem; margin: 0; font-weight: 500;">
                            <input type="checkbox" id="accessAbsences" checked> Bajas M√©dicas
                        </label>
                        <label class="form-label" style="display:flex; align-items:center; gap: .5rem; margin: 0; font-weight: 500;">
                            <input type="checkbox" id="accessPermissions" checked> Ausencias y Permisos
                        </label>
                        <label class="form-label" style="display:flex; align-items:center; gap: .5rem; margin: 0; font-weight: 500;">
                            <input type="checkbox" id="accessReports" checked> Reportes
                        </label>
                        <label class="form-label" style="display:flex; align-items:center; gap: .5rem; margin: 0; font-weight: 500;">
                            <input type="checkbox" id="accessLocations" checked> Ubicaciones
                        </label>
                        <label class="form-label" style="display:flex; align-items:center; gap: .5rem; margin: 0; font-weight: 500;">
                            <input type="checkbox" id="accessSettings"> Configuraci√≥n (solapes)
                        </label>
                    </div>
                </div>

                <button onclick="saveCoordinatorSettings()" class="btn btn-primary" style="margin-top: 1rem;">üíæ Guardar Configuraci√≥n del Coordinador</button>
            </div>
        </div>
    </main>

    <script src="js/api.js"></script>
    <script src="js/branding.js"></script>
    <script>
        if (!isAuthenticated()) {
            window.location.href = 'index.html';
        }

        const currentUser = getUser();

        // Fallback para evitar problemas de cach√© con api.js
        if (typeof settingsAPI === 'undefined') {
            console.warn('settingsAPI no encontrado en api.js (cach√©?), definiendo localmente...');
            window.settingsAPI = {
                get: () => callAPI(`${API_URL}/settings`),
                getAdmin: () => callAPI(`${API_URL}/settings/admin`),
                getAccess: () => callAPI(`${API_URL}/settings/access`),
                getOverlapRules: (params = {}) => {
                    const query = new URLSearchParams(params).toString();
                    return callAPI(`${API_URL}/settings/overlap-rules${query ? '?' + query : ''}`);
                },
                getOverlapRuleTargets: () => callAPI(`${API_URL}/settings/overlap-rules/targets`),
                getVacationPolicy: () => callAPI(`${API_URL}/settings/vacation-policy`),
                updateStoreCoordinator: (data) => callAPI(`${API_URL}/settings/store-coordinator`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                }),
                update: (data) => callAPI(`${API_URL}/settings`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                }),
                updateOverlapRules: (data) => callAPI(`${API_URL}/settings/overlap-rules`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                }),
                updateVacationPolicy: (data) => callAPI(`${API_URL}/settings/vacation-policy`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                }),
                updateAdmin: (data) => callAPI(`${API_URL}/settings/admin-credentials`, {
                    method: 'PUT',
                    body: JSON.stringify(data)
                })
            };
        }

        let currentLogoBase64 = '';
        let coordinatorUserExists = false;

        function hideElementById(id) {
            const el = document.getElementById(id);
            if (el) el.style.display = 'none';
        }

        function applyOverlapRulesToUI(rules) {
            const r = rules || {};
            document.getElementById('ov_vac_vac').checked = r?.vacation?.vacation !== false;
            document.getElementById('ov_vac_perm').checked = r?.vacation?.permission !== false;
            document.getElementById('ov_vac_abs').checked = r?.vacation?.absence !== false;
            document.getElementById('ov_perm_perm').checked = r?.permission?.permission !== false;
            document.getElementById('ov_perm_abs').checked = r?.permission?.absence !== false;
            document.getElementById('ov_abs_abs').checked = r?.absence?.absence !== false;
        }

        async function loadOverlapRules() {
            try {
                const target = document.getElementById('overlapTarget')?.value || '__global__';
                const params = target && target !== '__global__' ? { location: target } : {};
                const data = await settingsAPI.getOverlapRules(params);
                if (!data || !data.overlap_rules) return;
                applyOverlapRulesToUI(data.overlap_rules);
            } catch (error) {
                console.error('Error cargando reglas de solapamiento:', error);
                showAlert('Error al cargar reglas de solapamiento', 'error');
            }
        }

        async function loadOverlapRuleTargets() {
            try {
                const sel = document.getElementById('overlapTarget');
                if (!sel) return;

                const data = await settingsAPI.getOverlapRuleTargets();
                const targets = (data && Array.isArray(data.targets)) ? data.targets : [];

                const current = sel.value || '__global__';
                const options = ['__global__', ...targets];

                sel.innerHTML = options
                    .map(v => v === '__global__'
                        ? `<option value="__global__">Global (todas las tiendas)</option>`
                        : `<option value="${String(v).replace(/"/g, '&quot;')}">${String(v)}</option>`
                    )
                    .join('');

                sel.value = options.includes(current) ? current : '__global__';
            } catch (error) {
                console.error('Error cargando ubicaciones disponibles:', error);
                // No bloqueamos la p√°gina; el usuario a√∫n puede usar global.
            }
        }

        async function saveOverlapRules() {
            const target = document.getElementById('overlapTarget')?.value || '__global__';

            const payload = {
                location: target !== '__global__' ? target : undefined,
                overlap_rules: {
                    vacation: {
                        vacation: document.getElementById('ov_vac_vac').checked,
                        permission: document.getElementById('ov_vac_perm').checked,
                        absence: document.getElementById('ov_vac_abs').checked
                    },
                    permission: {
                        // vacation es sim√©trico de vacation.permission
                        vacation: document.getElementById('ov_vac_perm').checked,
                        permission: document.getElementById('ov_perm_perm').checked,
                        absence: document.getElementById('ov_perm_abs').checked
                    },
                    absence: {
                        // vacation/permission son sim√©tricos
                        vacation: document.getElementById('ov_vac_abs').checked,
                        permission: document.getElementById('ov_perm_abs').checked,
                        absence: document.getElementById('ov_abs_abs').checked
                    }
                }
            };

            const result = await settingsAPI.updateOverlapRules(payload);
            if (result) {
                showAlert('Reglas de solapamiento actualizadas correctamente', 'success');
                await loadOverlapRules();
            }
        }

        function applyVacationPolicyToUI(policy) {
            const p = policy || {};
            document.getElementById('vpProrationEnabled').checked = !!p.proration_enabled;
            document.getElementById('vpProrationRounding').value = (p.proration_rounding_increment ?? 0.5);
            document.getElementById('vpCarryoverEnabled').checked = !!p.carryover_enabled;
            document.getElementById('vpCarryoverMax').value = (p.carryover_max_days ?? 0);
            document.getElementById('vpCarryoverExpiry').value = (p.carryover_expiry_month_day ?? '03-31');
        }

        async function loadVacationPolicy() {
            try {
                const data = await settingsAPI.getVacationPolicy();
                if (!data || !data.vacation_policy) return;
                applyVacationPolicyToUI(data.vacation_policy);
            } catch (error) {
                console.error('Error cargando pol√≠tica de vacaciones:', error);
                showAlert('Error al cargar el saldo anual avanzado', 'error');
            }
        }

        async function saveVacationPolicy() {
            try {
                const rounding = Number(document.getElementById('vpProrationRounding').value);
                const carryMax = Number(document.getElementById('vpCarryoverMax').value);
                const expiry = String(document.getElementById('vpCarryoverExpiry').value || '').trim();

                const payload = {
                    vacation_policy: {
                        proration_enabled: document.getElementById('vpProrationEnabled').checked,
                        proration_rounding_increment: Number.isFinite(rounding) ? rounding : 0.5,
                        carryover_enabled: document.getElementById('vpCarryoverEnabled').checked,
                        carryover_max_days: Number.isFinite(carryMax) ? carryMax : 0,
                        carryover_expiry_month_day: expiry
                    }
                };

                const result = await settingsAPI.updateVacationPolicy(payload);
                if (result) {
                    showAlert('Saldo anual avanzado actualizado correctamente', 'success');
                    await loadVacationPolicy();
                }
            } catch (error) {
                console.error('Error guardando pol√≠tica de vacaciones:', error);
                showAlert('Error al guardar el saldo anual avanzado', 'error');
            }
        }

        // Cargar configuraci√≥n al iniciar
        async function loadSettings() {
            try {
                const settings = await settingsAPI.get();
                if (settings) {
                    document.getElementById('companyName').value = settings.company_name || '';
                    document.getElementById('companyCif').value = settings.company_cif || '';
                    document.getElementById('companyAddress').value = settings.company_address || '';
                    
                    // Cargar PINs de regularizaci√≥n
                    document.getElementById('regularizationAdminPin').value = settings.regularization_admin_pin || '1234';
                    document.getElementById('regularizationCoordinatorPin').value = settings.regularization_coordinator_pin || '5678';

                    if (settings.logo_base64) {
                        currentLogoBase64 = settings.logo_base64;
                        document.getElementById('logoPreview').innerHTML = `<img src="${settings.logo_base64}" alt="Logo">`;

                        // Actualizar logo en la sidebar live
                        if (typeof window.applyCompanyBranding === 'function') {
                            window.applyCompanyBranding(settings);
                        } else {
                            updateSidebarLogo(settings.logo_base64);
                        }
                    }
                }
            } catch (error) {
                console.error('Error cargando configuraci√≥n:', error);
                showAlert('Error al cargar la configuraci√≥n', 'error');
            }
        }

        async function loadCoordinatorSettings() {
            try {
                const data = await settingsAPI.getAdmin();
                if (!data || !data.settings) return;

                const s = data.settings;

                document.getElementById('coordinatorEnabled').checked = !!s.store_coordinator_enabled;
                document.getElementById('storeLocations').value = Array.isArray(s.store_locations) ? s.store_locations.join('\n') : '';

                const access = s.store_coordinator_access || {};
                document.getElementById('accessEmployees').checked = access.employees !== false;
                document.getElementById('accessAttendance').checked = access.attendance !== false;
                document.getElementById('accessVacations').checked = access.vacations !== false;
                document.getElementById('accessAbsences').checked = access.absences !== false;
                document.getElementById('accessPermissions').checked = access.permissions !== false;
                document.getElementById('accessReports').checked = access.reports !== false;
                document.getElementById('accessLocations').checked = access.locations !== false;
                document.getElementById('accessSettings').checked = access.settings === true;

                const u = data.store_coordinator_user;
                document.getElementById('coordinatorUsername').value = u?.username || '';
                document.getElementById('coordinatorPassword').value = '';
                coordinatorUserExists = !!(u && u.username);
            } catch (error) {
                console.error('Error cargando coordinador:', error);
                showAlert('Error al cargar el perfil de Coordinador', 'error');
            }
        }

        async function saveCoordinatorSettings() {
            const enabled = document.getElementById('coordinatorEnabled').checked;
            const username = document.getElementById('coordinatorUsername').value.trim();
            const password = document.getElementById('coordinatorPassword').value;
            const storeLocations = document.getElementById('storeLocations').value;

            if (enabled && !username) {
                showAlert('Introduce un usuario para activar el Coordinador', 'warning');
                return;
            }

            if (enabled && !coordinatorUserExists && !password) {
                showAlert('Introduce una contrase√±a para crear el Coordinador por primera vez', 'warning');
                return;
            }

            const payload = {
                enabled,
                username: username || undefined,
                password: password || undefined,
                store_locations: storeLocations,
                access: {
                    // dashboard se deja por defecto true en backend
                    employees: document.getElementById('accessEmployees').checked,
                    attendance: document.getElementById('accessAttendance').checked,
                    vacations: document.getElementById('accessVacations').checked,
                    absences: document.getElementById('accessAbsences').checked,
                    permissions: document.getElementById('accessPermissions').checked,
                    reports: document.getElementById('accessReports').checked,
                    locations: document.getElementById('accessLocations').checked,
                    settings: document.getElementById('accessSettings').checked
                }
            };

            const result = await settingsAPI.updateStoreCoordinator(payload);
            if (result) {
                showAlert('Configuraci√≥n del Coordinador actualizada correctamente', 'success');
                document.getElementById('coordinatorPassword').value = '';
                await loadCoordinatorSettings();
            }
        }

        // Manejar subida de logo
        function handleLogoUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    currentLogoBase64 = e.target.result;
                    document.getElementById('logoPreview').innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Actualizar logo en sidebar
        function updateSidebarLogo(src) {
            const logoContainer = document.querySelector('.sidebar-logo');
            if (!logoContainer) return;
            // Reemplazar icono por imagen peque√±a
            logoContainer.innerHTML = `
                <img src="${src}" style="height: 30px; width: auto; max-width: 30px; object-fit: contain;">
                <span>Gesti√≥n RH</span>
            `;
        }

        // Guardar PINs de regularizaci√≥n
        async function saveRegularizationPins() {
            const adminPin = document.getElementById('regularizationAdminPin').value.trim();
            const coordinatorPin = document.getElementById('regularizationCoordinatorPin').value.trim();

            // Validaci√≥n
            if (adminPin && !/^\d{4}$/.test(adminPin)) {
                showAlert('El PIN de administrador debe ser exactamente 4 d√≠gitos num√©ricos', 'warning');
                return;
            }
            if (coordinatorPin && !/^\d{4}$/.test(coordinatorPin)) {
                showAlert('El PIN de coordinador debe ser exactamente 4 d√≠gitos num√©ricos', 'warning');
                return;
            }
            if (adminPin && coordinatorPin && adminPin === coordinatorPin) {
                showAlert('Los PINs deben ser diferentes entre s√≠', 'warning');
                return;
            }

            const data = {
                regularization_admin_pin: adminPin || '1234',
                regularization_coordinator_pin: coordinatorPin || '5678'
            };

            const result = await settingsAPI.update(data);
            if (result) {
                showAlert('PINs de regularizaci√≥n actualizados correctamente', 'success');
            }
        }

        // Guardar configuraci√≥n de empresa
        async function saveCompanySettings() {
            const data = {
                company_name: document.getElementById('companyName').value,
                company_cif: document.getElementById('companyCif').value,
                company_address: document.getElementById('companyAddress').value,
                logo_base64: currentLogoBase64
            };

            const result = await settingsAPI.update(data);
            if (result) {
                showAlert('Datos de empresa actualizados correctamente', 'success');
                if (data.logo_base64) {
                    if (typeof window.applyCompanyBranding === 'function') {
                        window.applyCompanyBranding(result);
                    } else {
                        updateSidebarLogo(data.logo_base64);
                    }
                }
            }
        }

        // Actualizar credenciales admin
        async function updateAdminCredentials() {
            const newUsername = document.getElementById('adminUser').value;
            const newPass = document.getElementById('adminPass').value;

            if (!newUsername && !newPass) {
                return showAlert('Introduce al menos un campo para actualizar', 'warning');
            }

            if (confirm('¬øEst√°s seguro de que quieres cambiar las credenciales de administrador? Tendr√°s que volver a iniciar sesi√≥n.')) {
                const result = await settingsAPI.updateAdmin({
                    new_username: newUsername,
                    new_password: newPass
                });

                if (result) {
                    showAlert('Credenciales actualizadas. Redirigiendo...', 'success');
                    setTimeout(() => {
                        logout();
                    }, 2000);
                }
            }
        }

        (async function initSettingsPage() {
            // Admin: acceso completo. Coordinador: solo si tiene access.settings.
            if (!currentUser) {
                window.location.href = 'dashboard.html';
                return;
            }

            let accessData = null;
            try {
                accessData = await settingsAPI.getAccess();
            } catch (_) {
                accessData = null;
            }

            const isAdminUser = currentUser.role === 'admin';
            const isCoordinatorWithSettings = currentUser.role === 'store_coordinator' && !!(accessData && accessData.access && accessData.access.settings);

            if (!isAdminUser && !isCoordinatorWithSettings) {
                window.location.href = 'dashboard.html';
                return;
            }

            if (isCoordinatorWithSettings) {
                // El coordinador solo puede tocar reglas de solape.
                hideElementById('companySection');
                hideElementById('adminSection');
                hideElementById('coordinatorSection');
                hideElementById('vacationPolicySection');
                await loadOverlapRuleTargets();
                await loadOverlapRules();
                return;
            }

            // Admin
            loadSettings();
            loadCoordinatorSettings();
            await loadOverlapRuleTargets();
            await loadOverlapRules();
            await loadVacationPolicy();
        })();
    </script>
</body>

</html>