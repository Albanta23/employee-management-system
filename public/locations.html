<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Ubicaciones</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .locations-grid,
        .stores-grid,
        .calendar-grid {
            display: grid;
            gap: var(--spacing-lg);
        }

        .locations-grid {
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }

        .stores-grid {
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }

        .calendar-grid {
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            margin-top: var(--spacing-lg);
        }

        .location-card,
        .store-card,
        .month-section {
            background: rgba(30, 41, 59, 0.38);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: var(--shadow-sm);
            transition: transform var(--transition-base), background var(--transition-base), border-color var(--transition-base);
        }

        .location-card,
        .store-card {
            cursor: pointer;
        }

        .location-card:hover,
        .store-card:hover {
            transform: translateY(-2px);
            background: rgba(30, 41, 59, 0.52);
            border-color: rgba(99, 102, 241, 0.35);
        }

        .location-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
        }

        .location-card-title {
            font-size: 1.125rem;
            font-weight: 700;
            margin: 0;
        }

        .location-card-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: var(--spacing-xs);
        }

        .location-card-stats {
            display: flex;
            gap: var(--spacing-md);
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: var(--spacing-md);
        }

        .store-card-title {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: var(--spacing-xs);
        }

        .store-card-address {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .calendar-title {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .calendar-controls {
            display: flex;
            gap: var(--spacing-md);
            align-items: center;
            flex-wrap: wrap;
        }

        .month-title {
            font-weight: 700;
            color: var(--primary-light);
            margin-bottom: var(--spacing-md);
            font-size: 0.95rem;
        }

        .month-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.35rem;
        }

        .dow {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-muted);
            text-align: center;
            padding: 0.35rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            margin-bottom: 0.25rem;
        }

        .day-cell {
            min-height: 56px;
            border-radius: var(--radius-md);
            padding: 0.35rem;
            background: rgba(15, 23, 42, 0.22);
            border: 1px solid rgba(255, 255, 255, 0.06);
            overflow: hidden;
        }

        .day-cell.empty {
            background: transparent;
            border-color: transparent;
        }

        .day-number {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--text-secondary);
            display: flex;
            justify-content: flex-end;
        }

        .day-holidays {
            margin-top: 0.25rem;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .holiday-chip {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.25rem;
            width: 100%;
            font-size: 0.72rem;
            padding: 0.2rem 0.35rem;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(30, 41, 59, 0.42);
            color: var(--text-primary);
        }

        /* Overrides en modo claro para que el calendario no quede gris */
        html.theme-light .month-section,
        html.theme-light .location-card,
        html.theme-light .store-card {
            background: rgba(255, 255, 255, 0.95);
            border-color: rgba(15, 23, 42, 0.1);
        }

        html.theme-light .location-card:hover,
        html.theme-light .store-card:hover {
            background: rgba(241, 245, 249, 1);
            border-color: rgba(99, 102, 241, 0.25);
        }

        html.theme-light .dow {
            border-bottom-color: rgba(15, 23, 42, 0.08);
        }

        html.theme-light .day-cell {
            background: rgba(248, 250, 252, 0.95);
            border-color: rgba(15, 23, 42, 0.08);
        }

        html.theme-light .holiday-chip {
            background: rgba(255, 255, 255, 0.95);
            border-color: rgba(15, 23, 42, 0.1);
        }

        .holiday-chip.national {
            border-left: 3px solid rgba(99, 102, 241, 0.9);
        }

        .holiday-chip.local {
            border-left: 3px solid rgba(245, 158, 11, 0.9);
        }

        .holiday-chip-name {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
        }

        .holiday-chip-actions {
            display: inline-flex;
            gap: 0.25rem;
            flex-shrink: 0;
        }

        .holiday-chip-actions button {
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0;
            line-height: 1;
            font-size: 0.85rem;
        }

        .holiday-chip-actions button:hover {
            color: var(--text-primary);
        }

        .holiday-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem;
            margin-bottom: 0.5rem;
            background: rgba(30, 41, 59, 0.7);
            border-radius: 6px;
            font-size: 0.85rem;
            border-left: 3px solid var(--success);
        }

        .holiday-item.national {
            border-left-color: var(--primary);
        }

        .holiday-item.local {
            border-left-color: var(--warning);
        }

        .store-move-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-lg);
        }

        .store-move-panel {
            background: rgba(30, 41, 59, 0.38);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        html.theme-light .store-move-panel {
            background: rgba(255, 255, 255, 0.95);
            border-color: rgba(15, 23, 42, 0.1);
        }

        .store-move-panel-title {
            font-weight: 700;
            margin-bottom: var(--spacing-md);
        }

        .store-move-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .store-move-store {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: 0.6rem 0.75rem;
            border-radius: var(--radius-md);
            border: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(15, 23, 42, 0.22);
            cursor: grab;
            user-select: none;
        }

        html.theme-light .store-move-store {
            background: rgba(248, 250, 252, 0.95);
            border-color: rgba(15, 23, 42, 0.08);
        }

        .store-move-store.dragging {
            opacity: 0.7;
            cursor: grabbing;
        }

        .store-move-store-name {
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .store-move-targets {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .store-move-target {
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            border: 1px dashed rgba(255, 255, 255, 0.18);
            background: rgba(15, 23, 42, 0.12);
        }

        html.theme-light .store-move-target {
            background: rgba(248, 250, 252, 0.95);
            border-color: rgba(15, 23, 42, 0.18);
        }

        .store-move-target.drag-over {
            border-style: solid;
        }

        .store-move-target-title {
            font-weight: 700;
            margin-bottom: 0.15rem;
        }

        .store-move-target-subtitle {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .employee-move-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-lg);
        }

        .employee-move-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            max-height: 520px;
            overflow: auto;
        }

        .employee-move-employee {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
            padding: 0.6rem 0.75rem;
            border-radius: var(--radius-md);
            border: 1px solid rgba(255, 255, 255, 0.08);
            background: rgba(15, 23, 42, 0.22);
            cursor: grab;
            user-select: none;
        }

        html.theme-light .employee-move-employee {
            background: rgba(248, 250, 252, 0.95);
            border-color: rgba(15, 23, 42, 0.08);
        }

        .employee-move-employee.dragging {
            opacity: 0.7;
            cursor: grabbing;
        }

        .employee-move-name {
            font-weight: 700;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .employee-move-meta {
            display: flex;
            gap: var(--spacing-sm);
            color: var(--text-muted);
            font-size: 0.85rem;
            overflow: hidden;
        }

        .employee-move-targets {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            max-height: 520px;
            overflow: auto;
        }

        .employee-move-target {
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            border: 1px dashed rgba(255, 255, 255, 0.18);
            background: rgba(15, 23, 42, 0.12);
        }

        html.theme-light .employee-move-target {
            background: rgba(248, 250, 252, 0.95);
            border-color: rgba(15, 23, 42, 0.18);
        }

        .employee-move-target.drag-over {
            border-style: solid;
        }

        .holiday-date {
            font-weight: bold;
            color: var(--text-primary);
        }

        .holiday-name {
            color: var(--text-secondary);
            flex: 1;
            margin: 0 0.5rem;
        }

        .holiday-type {
            font-size: 0.75rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            background: var(--primary-light);
            color: white;
        }

        .holiday-type.local {
            background: var(--warning);
        }

        .holiday-actions {
            display: flex;
            gap: 0.3rem;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
            flex-wrap: wrap;
        }

        .breadcrumb-item {
            cursor: pointer;
            color: var(--primary);
            text-decoration: none;
        }

        .breadcrumb-item:hover {
            text-decoration: underline;
        }

        .breadcrumb-separator {
            color: var(--text-secondary);
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }

        .btn-icon { padding: 0.4rem 0.6rem; font-size: 0.85rem; }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .locations-grid,
            .stores-grid {
                grid-template-columns: 1fr;
            }

            .calendar-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <span>üë•</span><span>Gesti√≥n RH</span>
            </div>
        </div>

        <ul class="sidebar-menu">
            <li class="menu-item"><a href="dashboard.html" class="menu-link"><span>üìä</span> Dashboard</a></li>
            <li class="menu-item"><a href="reports.html" class="menu-link"><span>üìà</span> Reportes</a></li>
            <li class="menu-item"><a href="employees.html" class="menu-link"><span>üë§</span> Trabajadores</a></li>
            <li class="menu-item"><a href="attendance-admin.html" class="menu-link"><span>üïí</span> Control Horario</a></li>
            <li class="menu-item"><a href="vacations.html" class="menu-link"><span>üèñÔ∏è</span> Vacaciones</a></li>
            <li class="menu-item"><a href="absences.html" class="menu-link"><span>üè•</span> Bajas M√©dicas</a></li>
            <li class="menu-item"><a href="permissions.html" class="menu-link"><span>üìÑ</span> Ausencias y Permisos</a></li>
            <li class="menu-item"><a href="locations.html" class="menu-link active"><span>üìç</span> Ubicaciones</a></li>
            <li class="menu-item"><a href="quadrants.html" class="menu-link"><span>üóìÔ∏è</span> Cuadrantes</a></li>
            <li class="menu-item"><a href="settings.html" class="menu-link"><span>‚öôÔ∏è</span> Configuraci√≥n</a></li>
        </ul>

        <div style="margin-top: auto; padding-top: var(--spacing-xl);">
            <button onclick="logout()" class="btn btn-secondary" style="width: 100%;">üö™ Cerrar Sesi√≥n</button>
        </div>
    </aside>

    <main class="main-content">
        <div class="card fade-in" style="margin-bottom: var(--spacing-xl);">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--spacing-md);">
                <div>
                    <h1 style="margin: 0;">Gesti√≥n de Ubicaciones</h1>
                    <p style="color: var(--text-muted); margin: 0.5rem 0 0 0;">Ubicaciones, tiendas y festivos locales</p>
                </div>
            </div>
        </div>

        <div id="alert-container"></div>

        <!-- Vista de Ubicaciones -->
        <div id="locations-view" class="content-section">
            <div class="card">
                <div class="card-header">
                    <h3 style="margin: 0;">üìç Ubicaciones</h3>
                    <div class="actions-grid" style="padding-top: 0;">
                        <select id="employee-export-stores-all" class="form-select" multiple style="display:none; min-width: 260px; max-width: 420px;">
                        </select>
                        <button id="btn-export-employees-all" class="btn btn-secondary" style="display: none;">
                            <span>üìÑ</span> Exportar empleados (PDF)
                        </button>
                        <button id="btn-add-location" class="btn btn-primary" style="display: none;">
                            <span>‚ûï</span> Nueva Ubicaci√≥n
                        </button>
                    </div>
                </div>
                <div id="locations-container" class="locations-grid"></div>
            </div>
        </div>

        <!-- Vista de Tiendas -->
        <div id="stores-view" class="content-section" style="display: none;">
            <div class="card">
                <div class="breadcrumb" style="margin-bottom: var(--spacing-lg);">
                    <span class="breadcrumb-item" onclick="showLocationsView()">üìç Ubicaciones</span>
                    <span class="breadcrumb-separator">‚Ä∫</span>
                    <span id="breadcrumb-location-name"></span>
                </div>

                <div class="card-header">
                    <div>
                        <h3 id="stores-view-title" style="margin: 0;">Tiendas</h3>
                        <div id="location-tabs-stores" style="display:none; gap: var(--spacing-sm); margin-top: var(--spacing-sm);">
                            <button id="tab-stores-stores" class="btn btn-primary" onclick="goToStoresTab()">üè™ Tiendas</button>
                            <button id="tab-employees-stores" class="btn btn-secondary" onclick="goToEmployeesTab()">üë• Empleados</button>
                        </div>
                    </div>
                    <div class="actions-grid" style="padding-top: 0;">
                        <button id="btn-add-store" class="btn btn-primary" style="display: none;">
                            <span>‚ûï</span> Nueva Tienda
                        </button>
                    </div>
                </div>

                <div id="stores-container" class="stores-grid"></div>
            </div>
        </div>

        <!-- Vista de Empleados (Drag & Drop) -->
        <div id="employees-view" class="content-section" style="display: none;">
            <div class="card">
                <div class="breadcrumb" style="margin-bottom: var(--spacing-lg);">
                    <span class="breadcrumb-item" onclick="showLocationsView()">üìç Ubicaciones</span>
                    <span class="breadcrumb-separator">‚Ä∫</span>
                    <span class="breadcrumb-item" id="breadcrumb-location-link-employees" onclick="goBackToStores()"></span>
                </div>

                <div class="card-header">
                    <div>
                        <h3 id="employees-view-title" style="margin: 0;">üë• Empleados</h3>
                        <div id="location-tabs-employees" style="display:none; gap: var(--spacing-sm); margin-top: var(--spacing-sm);">
                            <button id="tab-stores-employees" class="btn btn-secondary" onclick="goToStoresTab()">üè™ Tiendas</button>
                            <button id="tab-employees-employees" class="btn btn-primary" onclick="goToEmployeesTab()">üë• Empleados</button>
                        </div>
                    </div>
                    <div style="display:flex; gap: var(--spacing-md); align-items:center;">
                        <div style="color: var(--text-muted); font-size: 0.9rem;">Arrastra un empleado y su√©ltalo en la tienda/f√°brica destino.</div>
                        <select id="employee-export-stores-location" class="form-select" multiple style="display:none; min-width: 260px; max-width: 420px;">
                        </select>
                        <button id="btn-export-employees-location" class="btn btn-secondary" style="display:none;">
                            <span>üìÑ</span> Exportar PDF
                        </button>
                    </div>
                </div>

                <div id="employees-view-body" class="employee-move-grid"></div>
            </div>
        </div>

        <!-- Vista de Calendario -->
        <div id="calendar-view" class="content-section" style="display: none;">
            <div class="card">
                <div class="breadcrumb" style="margin-bottom: var(--spacing-lg);">
                    <span class="breadcrumb-item" onclick="showLocationsView()">üìç Ubicaciones</span>
                    <span class="breadcrumb-separator">‚Ä∫</span>
                    <span class="breadcrumb-item" id="breadcrumb-location-link" onclick="goBackToStores()"></span>
                    <span class="breadcrumb-separator">‚Ä∫</span>
                    <span id="breadcrumb-store-name"></span>
                </div>

                <div class="calendar-header">
                    <div>
                        <div class="calendar-title" id="calendar-store-title"></div>
                        <div style="color: var(--text-muted); margin-top: var(--spacing-xs);">
                            Calendario laboral con festivos nacionales y locales
                        </div>
                    </div>
                    <div class="calendar-controls">
                        <select id="year-selector" class="form-select" style="width: auto; min-width: 120px;"></select>
                        <button id="btn-add-holiday" class="btn btn-primary">
                            <span>‚ûï</span> A√±adir Festivo Local
                        </button>
                    </div>
                </div>

                <div id="calendar-grid" class="calendar-grid"></div>
            </div>
        </div>
    </main>

    <!-- Modal para Nueva/Editar Ubicaci√≥n -->
    <div id="location-modal" class="modal">
        <div class="modal-content">
            <button class="btn-close" onclick="closeLocationModal()" title="Cerrar">√ó</button>
            <h2 id="location-modal-title" style="margin-bottom: var(--spacing-lg);">Nueva Ubicaci√≥n</h2>
            <form id="location-form">
                <input type="hidden" id="location-id">
                <div class="form-group">
                    <label class="form-label" for="location-name">Nombre de la Ubicaci√≥n *</label>
                    <input class="form-control" type="text" id="location-name" required placeholder="Ej: Madrid, Barcelona, Andaluc√≠a">
                </div>
                <div class="form-group">
                    <label class="form-label" for="location-description">Descripci√≥n</label>
                    <textarea class="form-control" id="location-description" placeholder="Descripci√≥n opcional de la ubicaci√≥n"></textarea>
                </div>
                <div style="display: flex; gap: var(--spacing-md); justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeLocationModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Nueva/Editar Tienda -->
    <div id="store-modal" class="modal">
        <div class="modal-content">
            <button class="btn-close" onclick="closeStoreModal()" title="Cerrar">√ó</button>
            <h2 id="store-modal-title" style="margin-bottom: var(--spacing-lg);">Nueva Tienda</h2>
            <form id="store-form">
                <input type="hidden" id="store-id">
                <div class="form-group">
                    <label class="form-label" for="store-name">Nombre de la Tienda *</label>
                    <input class="form-control" type="text" id="store-name" required placeholder="Ej: Tienda Centro, Tienda Norte">
                </div>
                <div class="form-group">
                    <label class="form-label" for="store-address">Direcci√≥n</label>
                    <textarea class="form-control" id="store-address" placeholder="Direcci√≥n de la tienda"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" for="store-clock-pin">PIN de tienda (portal tablet)</label>
                    <input class="form-control" type="password" id="store-clock-pin" placeholder="Dejar vac√≠o para no cambiar" autocomplete="new-password">
                </div>
                <div style="display: flex; gap: var(--spacing-md); justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeStoreModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para A√±adir/Editar Festivo Local -->
    <div id="holiday-modal" class="modal">
        <div class="modal-content">
            <button class="btn-close" onclick="closeHolidayModal()" title="Cerrar">√ó</button>
            <h2 id="holiday-modal-title" style="margin-bottom: var(--spacing-lg);">A√±adir Festivo Local</h2>
            <form id="holiday-form">
                <input type="hidden" id="holiday-id">
                <div class="form-group">
                    <label class="form-label" for="holiday-date">Fecha *</label>
                    <input class="form-control" type="date" id="holiday-date" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="holiday-name">Nombre del Festivo *</label>
                    <input class="form-control" type="text" id="holiday-name" required placeholder="Ej: Fiestas Patronales">
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="holiday-recurring">
                        <label class="form-label" for="holiday-recurring" style="margin: 0;">Festivo recurrente (cada a√±o)</label>
                    </div>
                </div>
                <div style="display: flex; gap: var(--spacing-md); justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeHolidayModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Gestionar Tiendas (Drag & Drop) -->
    <div id="store-move-modal" class="modal">
        <div class="modal-content" style="max-width: 980px;">
            <button class="btn-close" onclick="closeStoreMoveModal()" title="Cerrar">√ó</button>
            <h2 id="store-move-modal-title" style="margin-bottom: var(--spacing-lg);">Gestionar tiendas</h2>
            <div id="store-move-modal-body" class="store-move-grid"></div>
            <div style="display:flex; justify-content:flex-end; margin-top: var(--spacing-lg);">
                <button type="button" class="btn btn-secondary" onclick="closeStoreMoveModal()">Cerrar</button>
            </div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/branding.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="js/reports.js"></script>
    <script src="js/locations.js"></script>
</body>
</html>
