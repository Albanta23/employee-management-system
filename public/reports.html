<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes - Gesti√≥n RH</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo"><span>üë•</span><span>Gesti√≥n RH</span></div>
        </div>
        <ul class="sidebar-menu">
            <li class="menu-item"><a href="dashboard.html" class="menu-link"><span>üìä</span> Dashboard</a></li>
            <li class="menu-item"><a href="reports.html" class="menu-link active"><span>üìà</span> Reportes</a></li>
            <li class="menu-item"><a href="employees.html" class="menu-link"><span>üë§</span> Trabajadores</a></li>
            <li class="menu-item"><a href="attendance-admin.html" class="menu-link"><span>üïí</span> Control Horario</a></li>
            <li class="menu-item"><a href="vacations.html" class="menu-link"><span>üèñÔ∏è</span> Vacaciones</a></li>
            <li class="menu-item"><a href="absences.html" class="menu-link"><span>üè•</span> Bajas M√©dicas</a></li>
            <li class="menu-item"><a href="permissions.html" class="menu-link"><span>üìÑ</span> Ausencias y Permisos</a></li>
            <li class="menu-item"><a href="locations.html" class="menu-link"><span>üìç</span> Ubicaciones</a></li>
            <li class="menu-item"><a href="settings.html" class="menu-link"><span>‚öôÔ∏è</span> Configuraci√≥n</a></li>
        </ul>
        <div style="margin-top: auto; padding-top: var(--spacing-xl);">
            <button onclick="logout()" class="btn btn-secondary" style="width: 100%;">üö™ Cerrar Sesi√≥n</button>
        </div>
    </aside>

    <main class="main-content">
        <div class="card fade-in" style="margin-bottom: var(--spacing-xl);">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--spacing-md);">
                <div>
                    <h1 style="margin: 0;">Reportes</h1>
                    <p style="color: var(--text-muted); margin: 0.5rem 0 0 0;">Informes de gesti√≥n con filtros y exportaci√≥n</p>
                </div>
                <div class="actions-grid" style="padding-top: 0;">
                    <button onclick="exportPDF()" class="btn btn-secondary"><span>üìÑ</span> PDF</button>
                    <button onclick="exportCSV()" class="btn btn-secondary"><span>üì§</span> CSV</button>
                </div>
            </div>
        </div>

        <div id="alert-container"></div>

        <div class="card" style="margin-bottom: var(--spacing-lg);">
            <div class="grid grid-cols-4">
                <div class="form-group">
                    <label class="form-label">Tipo de reporte</label>
                    <select id="reportType" class="form-select" onchange="onReportTypeChange()">
                        <option value="attendance">Fichajes</option>
                        <option value="vacation">Consumo de vacaciones (por empleado)</option>
                        <option value="absences">Absentismo por causa</option>
                        <option value="monthly">Resumen mensual por tienda</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Ubicaci√≥n</label>
                    <select id="locationFilter" class="form-select">
                        <option value="">Todas</option>
                    </select>
                </div>

                <div class="form-group" id="periodGroup">
                    <label class="form-label">Per√≠odo</label>
                    <select id="periodFilter" class="form-select" onchange="onPeriodChange()">
                        <option value="custom">Personalizado</option>
                        <option value="week">Esta semana</option>
                        <option value="last-week">Semana pasada</option>
                        <option value="month">Este mes</option>
                        <option value="last-month">Mes pasado</option>
                        <option value="year">Este a√±o</option>
                    </select>
                </div>

                <div class="form-group" id="dateStartGroup">
                    <label class="form-label">Fecha inicio</label>
                    <input type="date" id="startDate" class="form-control">
                </div>

                <div class="form-group" id="dateEndGroup">
                    <label class="form-label">Fecha fin</label>
                    <input type="date" id="endDate" class="form-control">
                </div>

                <div class="form-group" id="monthGroup" style="display:none;">
                    <label class="form-label">Mes</label>
                    <input type="month" id="month" class="form-control">
                </div>

                <div class="form-group" style="display: flex; align-items: flex-end;">
                    <button onclick="loadReport()" class="btn btn-primary" style="width: 100%;">üîç Generar</button>
                </div>
            </div>

            <p style="color: var(--text-muted); font-size: 0.8rem; margin: 0.75rem 0 0 0;">
                Nota: los totales se calculan sobre el rango seleccionado.
            </p>
        </div>

        <div class="card">
            <div class="table-container">
                <table>
                    <thead>
                        <tr id="reportHeadRow">
                            <th>‚Äî</th>
                        </tr>
                    </thead>
                    <tbody id="reportBody">
                        <tr>
                            <td style="text-align: center; padding: 2rem; color: var(--text-muted);">Usa los filtros y pulsa Generar</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script src="js/api.js"></script>
    <script src="js/branding.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="js/reports.js"></script>

    <script>
        if (!isAuthenticated()) window.location.href = 'index.html';

        const currentUser = getUser();
        if (currentUser && currentUser.role === 'employee') {
            window.location.href = 'employee-dashboard.html';
        }

        let currentExport = { title: '', columns: [], rows: [], fileName: 'Reporte' };
        let currentAttendanceLogs = [];

        function toISODate(d) {
            const dt = new Date(d);
            if (Number.isNaN(dt.getTime())) return '';
            return dt.toISOString().split('T')[0];
        }

        async function initLocationFilter() {
            const data = await employeesAPI.getAll({ status: 'active', limit: 2000 });
            const list = data && data.employees ? data.employees : [];
            const locations = Array.from(new Set(list.map(e => (e.location || '').trim()).filter(Boolean))).sort();

            const sel = document.getElementById('locationFilter');
            const current = sel.value;
            sel.innerHTML = `<option value="">Todas</option>` + locations.map(l => `<option value="${l.replace(/"/g, '&quot;')}">${l}</option>`).join('');
            sel.value = locations.includes(current) ? current : '';
        }

        function onReportTypeChange() {
            const type = document.getElementById('reportType').value;
            const monthGroup = document.getElementById('monthGroup');
            const startGroup = document.getElementById('dateStartGroup');
            const endGroup = document.getElementById('dateEndGroup');
            const periodGroup = document.getElementById('periodGroup');

            if (type === 'monthly') {
                monthGroup.style.display = '';
                startGroup.style.display = 'none';
                endGroup.style.display = 'none';
                periodGroup.style.display = 'none';
            } else if (type === 'attendance') {
                monthGroup.style.display = 'none';
                startGroup.style.display = '';
                endGroup.style.display = '';
                periodGroup.style.display = '';
            } else {
                monthGroup.style.display = 'none';
                startGroup.style.display = '';
                endGroup.style.display = '';
                periodGroup.style.display = 'none';
            }
        }

        function onPeriodChange() {
            const period = document.getElementById('periodFilter').value;
            const now = new Date();
            let start, end;

            switch (period) {
                case 'week':
                    // Esta semana (lunes a domingo)
                    const day = now.getDay();
                    const diff = day === 0 ? -6 : 1 - day; // Ajustar al lunes
                    start = new Date(now);
                    start.setDate(now.getDate() + diff);
                    end = new Date(start);
                    end.setDate(start.getDate() + 6);
                    break;

                case 'last-week':
                    // Semana pasada
                    const lastWeekDay = now.getDay();
                    const lastWeekDiff = lastWeekDay === 0 ? -6 : 1 - lastWeekDay;
                    start = new Date(now);
                    start.setDate(now.getDate() + lastWeekDiff - 7);
                    end = new Date(start);
                    end.setDate(start.getDate() + 6);
                    break;

                case 'month':
                    // Este mes
                    start = new Date(now.getFullYear(), now.getMonth(), 1);
                    end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    break;

                case 'last-month':
                    // Mes pasado
                    start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    end = new Date(now.getFullYear(), now.getMonth(), 0);
                    break;

                case 'year':
                    // Este a√±o
                    start = new Date(now.getFullYear(), 0, 1);
                    end = new Date(now.getFullYear(), 11, 31);
                    break;

                default:
                    // Personalizado - no hacer nada
                    return;
            }

            document.getElementById('startDate').value = toISODate(start);
            document.getElementById('endDate').value = toISODate(end);
        }

        function setTable(columns, rows) {
            const head = document.getElementById('reportHeadRow');
            const body = document.getElementById('reportBody');

            head.innerHTML = columns.map(c => `<th>${c}</th>`).join('');

            if (!rows || rows.length === 0) {
                body.innerHTML = `<tr><td colspan="${columns.length}" style="text-align:center; padding: 2rem; color: var(--text-muted);">Sin resultados</td></tr>`;
                return;
            }

            body.innerHTML = rows.map(r => `<tr>${r.map(v => `<td>${v}</td>`).join('')}</tr>`).join('');
        }

        async function loadReport() {
            const type = document.getElementById('reportType').value;
            const location = document.getElementById('locationFilter').value;

            const body = document.getElementById('reportBody');
            body.innerHTML = `<tr><td style="text-align:center; padding: 2rem;">Cargando...</td></tr>`;

            if (type === 'attendance') {
                const start_date = document.getElementById('startDate').value;
                const end_date = document.getElementById('endDate').value;

                const params = {};
                if (start_date) params.start_date = start_date;
                if (end_date) params.end_date = end_date;

                const allLogs = await attendanceAPI.getReport(params);
                if (!allLogs || allLogs.length === 0) {
                    setTable(['Fecha', 'Empleado', 'Ubicaci√≥n', 'Fichajes'], [['Sin resultados']]);
                    currentAttendanceLogs = [];
                    return;
                }

                // Enriquecer con vacaciones
                await enrichWithVacations(allLogs, start_date, end_date);
                
                // Generar logs sint√©ticos para vacaciones sin fichajes
                const logsWithVacations = generateVacationDays(allLogs, start_date, end_date);

                // Filtrar por ubicaci√≥n si est√° seleccionada
                const logs = location ? logsWithVacations.filter(log => log.location === location) : logsWithVacations;
                
                if (logs.length === 0) {
                    setTable(['Fecha', 'Empleado', 'Ubicaci√≥n', 'Fichajes'], [['Sin resultados para la ubicaci√≥n seleccionada']]);
                    currentAttendanceLogs = [];
                    return;
                }

                // Guardar logs originales para exportaci√≥n
                currentAttendanceLogs = logs;

                // Agrupar por empleado y fecha
                const grouped = {};
                logs.forEach(log => {
                    const dateKey = new Date(log.timestamp).toISOString().split('T')[0];
                    const key = `${log.employee_id}_${dateKey}`;

                    if (!grouped[key]) {
                        grouped[key] = {
                            date: new Date(log.timestamp).toLocaleDateString('es-ES'),
                            dateISO: dateKey,
                            employee: log.full_name,
                            location: log.location || '-',
                            logs: []
                        };
                    }
                    grouped[key].logs.push(log);
                });

                // Ordenar los grupos por fecha (descendente) y luego por empleado (alfab√©tico)
                const sortedGroups = Object.values(grouped).sort((a, b) => {
                    const dateA = new Date(a.dateISO);
                    const dateB = new Date(b.dateISO);
                    
                    // Primero ordenar por fecha (descendente - m√°s reciente primero)
                    if (dateB.getTime() !== dateA.getTime()) {
                        return dateB - dateA;
                    }
                    
                    // Si es la misma fecha, ordenar por nombre de empleado (alfab√©tico)
                    return a.employee.localeCompare(b.employee);
                });

                const emojis = { in: 'üü¢', out: 'üî¥', break_start: 'üü†', break_end: 'üîµ' };
                const columns = ['Fecha', 'Empleado', 'Ubicaci√≥n', 'Fichajes'];
                const rows = sortedGroups.map(g => {
                    g.logs.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    
                    // Verificar si es un d√≠a de vacaciones sin fichajes
                    if (g.logs.length === 1 && g.logs[0].isVacationDay) {
                        return [
                            g.date, 
                            g.employee || '(Empleado)', 
                            g.location || '-', 
                            `üèñÔ∏è VACACIONES (${g.logs[0].dateRange})`
                        ];
                    }
                    
                    const fichajes = g.logs.map(l => {
                        const time = new Date(l.timestamp).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                        return `${emojis[l.type]} ${time}`;
                    }).join(' | ');

                    return [g.date, g.employee, g.location, fichajes];
                });

                const title = `Fichajes (${start_date || '...'} a ${end_date || '...'})`;
                const fileName = `Fichajes_${start_date}_${end_date}`;

                currentExport = { title, columns, rows, fileName };
                setTable(columns, rows);
                return;
            }

            if (type === 'vacation') {
                const start_date = document.getElementById('startDate').value;
                const end_date = document.getElementById('endDate').value;

                const data = await reportsAPI.getVacationConsumption({ start_date, end_date, ...(location ? { location } : {}), type: 'vacation' });
                if (!data) {
                    setTable(['‚Äî'], [[ 'No se pudo generar el reporte' ]]);
                    return;
                }

                const columns = ['Empleado', 'DNI', 'Ubicaci√≥n', 'Aprobadas', 'Pendientes', 'Total'];
                const rows = (data.rows || []).map(x => [
                    x.full_name || '-',
                    x.dni || '-',
                    x.location || '-',
                    (x.approved_days ?? 0),
                    (x.pending_days ?? 0),
                    (x.total_requested_days ?? 0)
                ]);

                const title = `Consumo de vacaciones (${toISODate(data.range.start)} a ${toISODate(data.range.end)})`;
                const fileName = `Consumo_Vacaciones_${toISODate(data.range.start)}_${toISODate(data.range.end)}`;

                currentExport = { title, columns, rows, fileName };
                setTable(columns, rows);
                return;
            }

            if (type === 'absences') {
                const start_date = document.getElementById('startDate').value;
                const end_date = document.getElementById('endDate').value;

                const data = await reportsAPI.getAbsencesByType({ start_date, end_date, ...(location ? { location } : {}) });
                if (!data) {
                    setTable(['‚Äî'], [[ 'No se pudo generar el reporte' ]]);
                    return;
                }

                const columns = ['Causa', 'Casos', 'Casos activos', 'D√≠as (rango)'];
                const rows = (data.rows || []).map(x => [
                    x.type || 'other',
                    (x.count ?? 0),
                    (x.active_count ?? 0),
                    (x.total_days ?? 0)
                ]);

                const title = `Absentismo por causa (${toISODate(data.range.start)} a ${toISODate(data.range.end)})`;
                const fileName = `Absentismo_${toISODate(data.range.start)}_${toISODate(data.range.end)}`;

                currentExport = { title, columns, rows, fileName };
                setTable(columns, rows);
                return;
            }

            if (type === 'monthly') {
                const month = document.getElementById('month').value;
                const data = await reportsAPI.getMonthlyLocationSummary({ month, ...(location ? { location } : {}) });
                if (!data) {
                    setTable(['‚Äî'], [[ 'No se pudo generar el reporte' ]]);
                    return;
                }

                const columns = ['Ubicaci√≥n', 'Empleados activos', 'Vacas aprobadas (d√≠as)', 'Vacas pendientes (d√≠as)', 'Bajas (d√≠as)', 'Bajas activas'];
                const rows = (data.rows || []).map(x => [
                    x.location || '-',
                    (x.active_employees ?? 0),
                    (x.vacation_approved_days ?? 0),
                    (x.vacation_pending_days ?? 0),
                    (x.absences_days ?? 0),
                    (x.absences_active_count ?? 0)
                ]);

                const title = `Resumen mensual por tienda (${data.month || month || ''})`;
                const fileName = `Resumen_Mensual_${data.month || month || ''}`;

                currentExport = { title, columns, rows, fileName };
                setTable(columns, rows);
                return;
            }
        }

        async function exportPDF() {
            const reportTypeElement = document.getElementById('reportType');
            if (!reportTypeElement) {
                console.error('Element reportType not found');
                showAlert('Error: No se pudo identificar el tipo de reporte', 'error');
                return;
            }
            
            const reportType = reportTypeElement.value;

            // Si es reporte de fichajes, usar el formato especial
            if (reportType === 'attendance') {
                if (!currentAttendanceLogs || currentAttendanceLogs.length === 0) {
                    showAlert('No hay datos de fichajes para exportar', 'warning');
                    return;
                }

                // Preparar agrupaci√≥n igual que attendance-admin.html
                const grouped = {};
                currentAttendanceLogs.forEach(log => {
                    const dateKey = new Date(log.timestamp).toLocaleDateString('es-ES');
                    const key = `${dateKey}_${log.dni || log.full_name}`;
                    if (!grouped[key]) {
                        grouped[key] = {
                            date: dateKey,
                            dateISO: new Date(log.timestamp).toISOString().split('T')[0],
                            employee: log.full_name,
                            employee_id: log.employee_id,
                            dni: log.dni,
                            location: log.location || '-',
                            logs: []
                        };
                    }
                    grouped[key].logs.push(log);
                });

                reportsUtil.exportGroupedAttendancePDF(
                    'REGISTRO DIARIO DE JORNADA (Real Decreto-ley 8/2019)',
                    grouped,
                    'Registro_Jornada_Detallado'
                );
                return;
            }

            // Para otros tipos de reportes, usar el m√©todo anterior
            if (!currentExport || !currentExport.columns || currentExport.columns.length === 0) {
                showAlert('Genera un reporte primero', 'warning');
                return;
            }
            if (!currentExport.rows || currentExport.rows.length === 0) {
                showAlert('No hay datos para exportar', 'warning');
                return;
            }

            const locationEl = document.getElementById('locationFilter');
            const startEl = document.getElementById('startDate');
            const endEl = document.getElementById('endDate');
            const monthEl = document.getElementById('month');
            
            const location = locationEl ? locationEl.value : '';
            const start = startEl ? startEl.value : '';
            const end = endEl ? endEl.value : '';
            const month = monthEl ? monthEl.value : '';

            const metaLines = [`Registros: ${currentExport.rows.length}`];
            if (location) metaLines.push(`Ubicaci√≥n: ${location}`);
            if (reportType === 'vacation' || reportType === 'absences') metaLines.push(`Rango: ${start} a ${end}`);
            if (reportType === 'monthly') metaLines.push(`Mes: ${month}`);

            await reportsUtil.exportTable(
                currentExport.title,
                currentExport.columns,
                currentExport.rows,
                currentExport.fileName,
                { orientation: 'l', metaLines }
            );
        }

        function exportCSV() {
            if (!currentExport || !currentExport.columns || currentExport.columns.length === 0) {
                showAlert('Genera un reporte primero', 'warning');
                return;
            }
            if (!currentExport.rows || currentExport.rows.length === 0) {
                showAlert('No hay datos para exportar', 'warning');
                return;
            }

            const escape = (v) => {
                const s = (v == null ? '' : String(v));
                if (/[\n\r",;]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
                return s;
            };

            const csv = [
                currentExport.columns.map(escape).join(','),
                ...currentExport.rows.map(r => r.map(escape).join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${(currentExport.fileName || 'Reporte').replace(/[^\w\-.]+/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => {
                try { URL.revokeObjectURL(url); } catch (_) { }
            }, 60 * 1000);
        }

        async function enrichWithVacations(logs, startDate, endDate, employeeId) {
            // Si se proporcionan par√°metros, usarlos directamente; sino extraerlos de logs
            let employeeIds, minDate, maxDate;
            
            if (employeeId && startDate && endDate) {
                employeeIds = [employeeId];
                minDate = startDate;
                maxDate = endDate;
            } else {
                // Obtener empleados √∫nicos y rango de fechas de los logs
                employeeIds = [...new Set(logs.map(l => l.employee_id).filter(Boolean))];
                if (employeeIds.length === 0) return;

                const dates = logs.map(l => new Date(l.timestamp).toISOString().split('T')[0]);
                minDate = dates.reduce((min, d) => d < min ? d : min, dates[0]);
                maxDate = dates.reduce((max, d) => d > max ? d : max, dates[0]);
            }

            // Consultar vacaciones aprobadas en el rango
            try {
                const allVacations = [];
                for (const empId of employeeIds) {
                    const vacations = await vacationsAPI.getAll({ employee_id: empId });
                    if (vacations && vacations.length > 0) {
                        const approved = vacations.filter(v => v.status === 'approved');
                        allVacations.push(...approved.map(v => ({ ...v, employee_id: empId })));
                    }
                }

                // Crear mapa de empleado + fecha -> informaci√≥n de vacaciones
                window.vacationsMap = {};
                allVacations.forEach(vac => {
                    const start = new Date(vac.start_date);
                    const end = new Date(vac.end_date);
                    
                    // Formatear fechas para mostrar
                    const startFormatted = start.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
                    const endFormatted = end.toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' });
                    const dateRange = `${startFormatted} - ${endFormatted}`;
                    
                    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                        const dateKey = d.toISOString().split('T')[0];
                        const mapKey = `${vac.employee_id}_${dateKey}`;
                        window.vacationsMap[mapKey] = {
                            hasVacation: true,
                            dateRange: dateRange,
                            startDate: vac.start_date,
                            endDate: vac.end_date
                        };
                    }
                });
                console.log('Vacaciones cargadas en reports.html:', Object.keys(window.vacationsMap).length);
            } catch (error) {
                console.error('Error cargando vacaciones:', error);
                window.vacationsMap = {};
            }
        }

        // Funci√≥n para generar logs sint√©ticos de d√≠as de vacaciones sin fichajes
        function generateVacationDays(logs, startDate, endDate) {
            if (!window.vacationsMap || Object.keys(window.vacationsMap).length === 0) {
                return logs;
            }

            // Validar que tengamos fechas v√°lidas
            if (!startDate || !endDate) {
                console.warn('No hay rango de fechas especificado para generar d√≠as de vacaciones');
                return logs;
            }

            const allLogs = [...logs];
            const existingDays = new Set();
            
            // Crear un mapa de employee_id -> datos del empleado
            const employeeDataMap = {};
            logs.forEach(log => {
                if (log.employee_id && !employeeDataMap[log.employee_id]) {
                    employeeDataMap[log.employee_id] = {
                        full_name: log.full_name || '',
                        dni: log.dni || '',
                        location: log.location || ''
                    };
                }
                
                const dateKey = new Date(log.timestamp).toISOString().split('T')[0];
                const mapKey = `${log.employee_id}_${dateKey}`;
                existingDays.add(mapKey);
            });

            // Generar logs sint√©ticos para d√≠as de vacaciones sin fichajes
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            // Validar que las fechas sean v√°lidas
            if (isNaN(start.getTime()) || isNaN(end.getTime())) {
                console.error('Fechas inv√°lidas:', startDate, endDate);
                return logs;
            }
            
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                const dateKey = d.toISOString().split('T')[0];
                
                // Revisar todos los empleados con vacaciones en este d√≠a
                Object.keys(window.vacationsMap).forEach(mapKey => {
                    if (mapKey.endsWith(`_${dateKey}`) && !existingDays.has(mapKey)) {
                        const employeeId = mapKey.split('_')[0];
                        const vacationInfo = window.vacationsMap[mapKey];
                        const empData = employeeDataMap[employeeId] || {};
                        
                        // Crear log sint√©tico con datos del empleado si est√°n disponibles
                        allLogs.push({
                            employee_id: employeeId,
                            timestamp: new Date(dateKey + 'T12:00:00').toISOString(),
                            type: 'vacation',
                            isVacationDay: true,
                            full_name: empData.full_name || '(Empleado)',
                            dni: empData.dni || '',
                            location: empData.location || '-',
                            dateRange: vacationInfo.dateRange
                        });
                    }
                });
            }

            return allLogs;
        }

        (function initDefaults() {
            const now = new Date();
            const yearStart = new Date(now.getFullYear(), 0, 1);
            const today = toISODate(now);
            const ys = toISODate(yearStart);

            document.getElementById('startDate').value = ys;
            document.getElementById('endDate').value = today;
            document.getElementById('month').value = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');

            initLocationFilter();
            onReportTypeChange();
            onPeriodChange();
        })();
    </script>
</body>

</html>
