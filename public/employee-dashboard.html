<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Portal del Empleado - Gesti√≥n RH</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        :root {
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 0px);
        }

        body {
            background: var(--bg-dark);
            padding-bottom: calc(80px + var(--safe-area-inset-bottom));
        }

        .header-mobile {
            padding: 2rem 1.5rem;
            background: linear-gradient(to bottom, var(--bg-sidebar) 0%, transparent 100%);
            margin-bottom: 1rem;
        }

        .welcome-text h1 {
            font-size: 1.5rem;
            margin: 0;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .clock-container {
            padding: 1.5rem;
            text-align: center;
        }

        #digital-clock {
            font-size: 3.5rem;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            margin-bottom: 0.5rem;
            color: var(--primary-light);
            text-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
        }

        #digital-date {
            color: var(--text-muted);
            font-size: 1rem;
            margin-bottom: 2rem;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 2rem;
        }

        .status-none {
            background: rgba(100, 116, 139, 0.1);
            color: #94a3b8;
        }

        .status-in {
            background: rgba(34, 197, 94, 0.1);
            color: #4ade80;
            border: 1px solid rgba(34, 197, 94, 0.2);
        }

        .status-break {
            background: rgba(245, 158, 11, 0.1);
            color: #fbbf24;
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .fichar-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .btn-fichar {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 2rem 1rem;
            border-radius: var(--radius-xl);
            font-weight: 700;
            font-size: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            cursor: pointer;
        }

        .btn-fichar:active {
            transform: scale(0.95);
        }

        .btn-in {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            box-shadow: 0 10px 20px -5px rgba(34, 197, 94, 0.3);
        }

        .btn-out {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 10px 20px -5px rgba(239, 68, 68, 0.3);
        }

        .btn-break {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: 0 10px 20px -5px rgba(245, 158, 11, 0.3);
        }

        .btn-resume {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            box-shadow: 0 10px 20px -5px rgba(99, 102, 241, 0.3);
        }

        .btn-fichar i {
            font-size: 2rem;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(20px);
            display: flex;
            justify-content: space-around;
            padding: 0.75rem 1rem calc(0.75rem + var(--safe-area-inset-bottom));
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .nav-item.active {
            color: var(--primary-light);
        }

        .nav-item i {
            font-size: 1.5rem;
        }

        .section-title {
            padding: 0 1.5rem;
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .request-card {
            background: rgba(30, 41, 59, 0.5);
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            margin: 0 1.5rem 1rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .request-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .request-info {
            flex: 1;
        }

        .request-info h4 {
            margin: 0 0 0.25rem;
            font-size: 1rem;
        }

        .request-info p {
            margin: 0;
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        #alert-container {
            position: fixed;
            top: 1rem;
            left: 1rem;
            right: 1rem;
            z-index: 2000;
        }

        .quick-actions {
            padding: 0 1.5rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .action-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-lg);
            padding: 1.5rem 1rem;
            text-align: center;
            text-decoration: none;
            color: white;
            transition: background 0.2s;
        }

        .action-card:active {
            background: rgba(255, 255, 255, 0.1);
        }

        .action-card i {
            font-size: 1.75rem;
            display: block;
            margin-bottom: 0.5rem;
        }

        .action-card span {
            font-size: 0.875rem;
            font-weight: 500;
        }

        /* Modal de Permiso Geo */
        #geo-notice-modal.modal {
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
        }

        #geo-notice-modal.active {
            display: flex;
        }

        #geo-notice-modal .modal-content {
            background: #1e293b;
            border: 1px solid rgba(99, 102, 241, 0.3);
            max-width: 400px;
            text-align: center;
            padding: 2rem;
        }

        .geo-icon-large {
            font-size: 4rem;
            margin-bottom: 1.5rem;
            display: block;
            filter: drop-shadow(0 0 10px rgba(99, 102, 241, 0.5));
        }
    </style>
</head>

<body>
    <div id="alert-container"></div>

    <!-- Modal Informativo Geopermiso -->
    <div id="geo-notice-modal" class="modal">
        <div class="modal-content">
            <span class="geo-icon-large">üì°</span>
            <h2 style="margin-top: 0;">Permiso de Ubicaci√≥n</h2>
            <p style="color: var(--text-muted); line-height: 1.6;">
                Para cumplir con la normativa de **Control Horario**, el sistema necesita registrar la ubicaci√≥n
                geogr√°fica √∫nicamente en el momento del fichaje.
            </p>
            <p
                style="font-size: 0.875rem; color: var(--primary-light); background: rgba(99, 102, 241, 0.1); padding: 0.75rem; border-radius: var(--radius-md); margin: 1.5rem 0;">
                üîí Tu privacidad es importante: No rastreamos tu ubicaci√≥n de forma continua, solo al emitir el fichaje.
            </p>
            <button onclick="acceptGeoNotice()" class="btn btn-primary" style="width: 100%; padding: 1rem;">
                Entendido y Continuar
            </button>
        </div>
    </div>

    <header class="header-mobile" style="display: flex; align-items: center; justify-content: space-between;">
        <div class="welcome-text">
            <p style="color: var(--text-muted); margin: 0;">Hola,</p>
            <h1 id="user-name">Cargando...</h1>
        </div>
        <a href="employee-profile.html" style="text-decoration: none;">
            <img id="header-avatar"
                src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2394a3b8'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E"
                style="width: 48px; height: 48px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(255,255,255,0.1); background: rgba(30,41,59,0.5);">
        </a>
    </header>

    <div class="clock-container">
        <div id="digital-clock">00:00:00</div>
        <div id="digital-date">Cargando fecha...</div>
        <div id="current-status" class="status-badge status-none">
            <span>‚ö™</span> No has fichado hoy
        </div>

        <div class="fichar-grid" id="fichar-controls">
            <!-- Cargado din√°micamente -->
        </div>
    </div>

    <div class="section-title">
        Solicitudes R√°pidas
    </div>

    <div class="quick-actions">
        <a href="employee-requests.html?type=vacation" class="action-card">
            <i>üèñÔ∏è</i>
            <span>Vacaciones</span>
        </a>
        <a href="employee-requests.html?type=permission" class="action-card">
            <i>üìÑ</i>
            <span>Permisos</span>
        </a>
        <a href="employee-requests.html?type=medical" class="action-card">
            <i>üè•</i>
            <span>Baja M√©dica</span>
        </a>
        <a href="#" onclick="logout()" class="action-card">
            <i>üö™</i>
            <span>Cerrar Sesi√≥n</span>
        </a>
    </div>

    <div class="section-title">
        Mis √öltimos Fichajes
    </div>

    <div id="recent-logs">
        <!-- Cargado din√°micamente -->
        <p style="text-align: center; color: var(--text-muted); padding: 2rem;">Cargando registros...</p>
    </div>

    <nav class="bottom-nav">
        <a href="employee-dashboard.html" class="nav-item active">
            <i>üè†</i>
            <span>Inicio</span>
        </a>
        <a href="employee-vacations.html" class="nav-item">
            <i>üèñÔ∏è</i>
            <span>Mis Vacas</span>
        </a>
        <a href="employee-reports.html" class="nav-item">
            <i>üìã</i>
            <span>Informes</span>
        </a>
        <a href="employee-profile.html" class="nav-item">
            <i>üë§</i>
            <span>Perfil</span>
        </a>
    </nav>

    <script src="js/api.js"></script>
    <script src="js/branding.js"></script>
    <script>
        const user = getUser();
        if (!user || user.role !== 'employee') window.location.href = 'index.html';

        document.getElementById('user-name').textContent = user.name.split(' ')[0] + ' üëã';

        // Cargar Avatar
        const storedAvatar = localStorage.getItem(`avatar_${user.employee_id}`);
        if (storedAvatar) {
            document.getElementById('header-avatar').src = storedAvatar;
        } else {
            // Fallback a UI Avatars si no hay local
            document.getElementById('header-avatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&background=6366f1&color=fff&size=200`;
        }

        // Digital Clock
        function updateClock() {
            const now = new Date();
            document.getElementById('digital-clock').textContent = now.toLocaleTimeString('es-ES', { hour12: false });
            document.getElementById('digital-date').textContent = now.toLocaleDateString('es-ES', {
                weekday: 'long',
                day: 'numeric',
                month: 'long'
            });
        }
        setInterval(updateClock, 1000);
        updateClock();

        // Control Horario Logic
        let currentStatus = 'none';

        async function loadStatus() {
            const data = await attendanceAPI.getStatus();
            if (data) {
                currentStatus = data.todayStatus;
                renderControls();
                updateStatusBadge(currentStatus);
                loadHistory();
            }
        }

        function updateStatusBadge(status) {
            const badge = document.getElementById('current-status');
            const map = {
                'none': { label: 'No has fichado hoy', emoji: '‚ö™', class: 'status-none' },
                'in': { label: 'En el trabajo', emoji: 'üü¢', class: 'status-in' },
                'out': { label: 'Jornada finalizada', emoji: 'üî¥', class: 'status-none' },
                'break_start': { label: 'En descanso', emoji: 'üü†', class: 'status-break' },
                'break_end': { label: 'De vuelta del descanso', emoji: 'üü¢', class: 'status-in' }
            };
            const config = map[status] || map.none;
            badge.className = 'status-badge ' + config.class;
            badge.innerHTML = `<span>${config.emoji}</span> ${config.label}`;
        }

        function renderControls() {
            const container = document.getElementById('fichar-controls');
            let buttons = '';

            if (currentStatus === 'none' || currentStatus === 'out') {
                buttons = `
                    <button class="btn-fichar btn-in" onclick="fichar('in')" style="grid-column: 1 / span 2;">
                        <i>üìç</i> EMPRENDER JORNADA
                    </button>
                `;
            } else if (currentStatus === 'in' || currentStatus === 'break_end') {
                buttons = `
                    <button class="btn-fichar btn-break" onclick="fichar('break_start')">
                        <i>‚òï</i> DESCANSO
                    </button>
                    <button class="btn-fichar btn-out" onclick="fichar('out')">
                        <i>üè†</i> SALIR
                    </button>
                `;
            } else if (currentStatus === 'break_start') {
                buttons = `
                    <button class="btn-fichar btn-resume" onclick="fichar('break_end')" style="grid-column: 1 / span 2;">
                        <i>üîÑ</i> REANUDAR TRABAJO
                    </button>
                `;
            }

            container.innerHTML = buttons;
        }

        async function fichar(type) {
            // Verificar si ha visto el aviso de geo
            if (!localStorage.getItem('geo_notice_accepted')) {
                window.pendingFicharType = type; // Guardar qu√© quer√≠a hacer
                document.getElementById('geo-notice-modal').classList.add('active');
                return;
            }

            executeFichar(type);
        }

        function acceptGeoNotice() {
            localStorage.setItem('geo_notice_accepted', 'true');
            document.getElementById('geo-notice-modal').classList.remove('active');
            if (window.pendingFicharType) {
                executeFichar(window.pendingFicharType);
                delete window.pendingFicharType;
            }
        }

        async function executeFichar(type) {
            // Mostrar indicador de carga/proceso
            const container = document.getElementById('fichar-controls');
            const originalHtml = container.innerHTML;

            // Buscar el bot√≥n pulsado para feedback visual
            const btns = container.querySelectorAll('button');
            btns.forEach(b => b.disabled = true);

            // Obtener geolocalizaci√≥n (solo al fichar)
            // Nota: en navegadores modernos la geolocalizaci√≥n requiere HTTPS (o localhost).
            // Importante: en algunos m√≥viles, si haces `await` antes de llamar a getCurrentPosition,
            // el navegador puede considerar que ya no es un gesto de usuario y no mostrar el prompt.
            let latitude = null, longitude = null;
            const isLocalhost = ['localhost', '127.0.0.1'].includes(window.location.hostname);
            const isSecure = window.isSecureContext || isLocalhost;

            function geoGetCurrentPosition(options) {
                return new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, options);
                });
            }

            if (!isSecure) {
                showAlert('‚ö†Ô∏è La ubicaci√≥n (GPS) requiere abrir la app en HTTPS. Se registrar√° el fichaje sin coordenadas.', 'warning');
            } else if ("geolocation" in navigator) {
                try {
                    // Intento 1: m√°s compatible (menos exigente). √ötil en m√≥viles.
                    const pos = await geoGetCurrentPosition({
                        timeout: 25000,
                        enableHighAccuracy: false,
                        maximumAge: 30000
                    });
                    latitude = pos.coords.latitude;
                    longitude = pos.coords.longitude;
                } catch (e1) {
                    // Intento 2: alta precisi√≥n (por si el 1 falla por provider)
                    try {
                        const pos2 = await geoGetCurrentPosition({
                            timeout: 25000,
                            enableHighAccuracy: true,
                            maximumAge: 0
                        });
                        latitude = pos2.coords.latitude;
                        longitude = pos2.coords.longitude;
                    } catch (e2) {
                        const err = e2 || e1;
                        const code = err && typeof err.code === 'number' ? err.code : null;
                        // 1: PERMISSION_DENIED, 2: POSITION_UNAVAILABLE, 3: TIMEOUT
                        if (code === 1) {
                            showAlert('‚ö†Ô∏è Permiso de ubicaci√≥n denegado. En el m√≥vil, activa Ubicaci√≥n para el navegador (Safari/Chrome) y vuelve a intentar.', 'warning');
                        } else if (code === 2) {
                            showAlert('‚ö†Ô∏è Ubicaci√≥n no disponible en este dispositivo ahora mismo. Se registrar√° el fichaje sin coordenadas.', 'warning');
                        } else if (code === 3) {
                            showAlert('‚ö†Ô∏è Tiempo de espera agotado al obtener GPS. Se registrar√° el fichaje sin coordenadas.', 'warning');
                        } else {
                            showAlert('‚ö†Ô∏è No se pudo obtener la ubicaci√≥n exacta, pero se registrar√° el fichaje.', 'warning');
                        }
                        console.warn('Geo no disponible o denegada:', err && err.message ? err.message : err);
                    }
                }
            }

            const device_info = `${navigator.platform} - ${navigator.userAgent.substring(0, 50)}`;

            const result = await attendanceAPI.register({
                type,
                latitude,
                longitude,
                device_info
            });

            if (result) {
                showAlert('Registro guardado correctamente', 'success');
                loadStatus();
            } else {
                btns.forEach(b => b.disabled = false);
            }
        }

        async function loadHistory() {
            // Cargar √∫ltimos 15 d√≠as
            const end = new Date();
            const start = new Date();
            start.setDate(end.getDate() - 15);

            const data = await attendanceAPI.getReport({
                start_date: start.toISOString().split('T')[0],
                end_date: end.toISOString().split('T')[0]
            });

            const container = document.getElementById('recent-logs');
            if (!data || data.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 1rem;">Sin registros recientes</p>';
                return;
            }

            // Agrupar por fecha
            const groups = {};
            data.forEach(log => {
                const dateKey = log.timestamp.split('T')[0];
                if (!groups[dateKey]) groups[dateKey] = [];
                groups[dateKey].push(log);
            });

            const sortedDates = Object.keys(groups).sort((a, b) => new Date(b) - new Date(a));
            const emojis = { in: 'üìç', out: 'üè†', break_start: '‚òï', break_end: 'üîÑ' };
            const labels = { in: 'Entrada', out: 'Salida', break_start: 'Inicio Descanso', break_end: 'Fin Descanso' };

            function renderLocationLine(log) {
                const hasCoords = log && log.latitude != null && log.longitude != null;
                if (hasCoords) {
                    const lat = Number(log.latitude);
                    const lon = Number(log.longitude);
                    if (!Number.isNaN(lat) && !Number.isNaN(lon)) {
                        return `<a href="https://www.google.com/maps?q=${lat},${lon}" target="_blank" style="color: var(--primary-light); text-decoration: none;">üìç Ver mapa</a>`;
                    }
                }
                return log.location || 'Ubicaci√≥n no disponible';
            }

            container.innerHTML = sortedDates.map(date => {
                const dayLogs = groups[date];
                // Ordenar logs cronol√≥gicamente dentro del d√≠a
                dayLogs.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                const dateObj = new Date(date);
                const dateStr = dateObj.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                const isToday = new Date().toDateString() === dateObj.toDateString();

                return `
                <details class="day-group" ${isToday ? 'open' : ''} style="margin-bottom: 1rem; background: rgba(30, 41, 59, 0.5); border-radius: var(--radius-lg); border: 1px solid rgba(255, 255, 255, 0.05); overflow: hidden;">
                    <summary style="padding: 1rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 600; text-transform: capitalize; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                            <span>${dateStr}</span>
                            ${isToday ? '<span style="font-size: 0.7em; background: var(--primary); padding: 2px 6px; border-radius: 4px; color: white;">HOY</span>' : ''}
                        </span>
                        <span style="background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 10px; font-size: 0.75rem;">
                            ${dayLogs.length}
                        </span>
                    </summary>
                    <div style="background: rgba(0,0,0,0.2); border-top: 1px solid rgba(255,255,255,0.05);">
                        ${dayLogs.map(log => {
                    const time = new Date(log.timestamp).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                    return `
                                <div style="display: flex; align-items: center; padding: 0.75rem 1rem; border-bottom: 1px solid rgba(255,255,255,0.02);">
                                    <div style="margin-right: 1rem; font-size: 1.25rem;">${emojis[log.type]}</div>
                                    <div style="flex: 1;">
                                        <div style="font-size: 0.875rem; font-weight: 500;">${labels[log.type]}</div>
                                        <div style="font-size: 0.75rem; color: var(--text-muted);">${renderLocationLine(log)}</div>
                                    </div>
                                    <div style="font-family: monospace; font-size: 0.9rem; color: var(--text-secondary);">${time}</div>
                                </div>
                            `;
                }).join('')}
                    </div>
                </details>
                `;
            }).join('');
        }

        loadStatus();
    </script>
</body>

</html>