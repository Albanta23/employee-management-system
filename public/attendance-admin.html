<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Horario - Sistema de Gesti√≥n</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo"><span>üë•</span><span>Gesti√≥n RH</span></div>
        </div>
        <ul class="sidebar-menu">
            <li class="menu-item"><a href="dashboard.html" class="menu-link"><span>üìä</span> Dashboard</a></li>
            <li class="menu-item"><a href="reports.html" class="menu-link"><span>üìà</span> Reportes</a></li>
            <li class="menu-item"><a href="employees.html" class="menu-link"><span>üë§</span> Trabajadores</a></li>
            <li class="menu-item"><a href="attendance-admin.html" class="menu-link active"><span>üïí</span> Control
                    Horario</a></li>
            <li class="menu-item"><a href="vacations.html" class="menu-link"><span>üèñÔ∏è</span> Vacaciones</a></li>
            <li class="menu-item"><a href="absences.html" class="menu-link"><span>üè•</span> Bajas M√©dicas</a></li>
            <li class="menu-item"><a href="permissions.html" class="menu-link"><span>üìÑ</span> Ausencias y Permisos</a>
            </li>
            <li class="menu-item"><a href="settings.html" class="menu-link"><span>‚öôÔ∏è</span> Configuraci√≥n</a></li>
        </ul>
        <div style="margin-top: auto; padding-top: var(--spacing-xl);">
            <button onclick="logout()" class="btn btn-secondary" style="width: 100%;">üö™ Cerrar Sesi√≥n</button>
        </div>
    </aside>

    <main class="main-content">
        <div class="card fade-in" style="margin-bottom: var(--spacing-xl);">
            <div
                style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--spacing-md);">
                <div>
                    <h1 style="margin: 0;">Registro de Jornada (Ley 8/2019)</h1>
                    <p style="color: var(--text-muted); margin: 0.5rem 0 0 0;">Consulta y exportaci√≥n del registro
                        diario de jornada obligatorio</p>
                </div>
                <div class="actions-grid" style="padding-top: 0;">
                    <button onclick="exportAttendancePDF()" class="btn btn-secondary">
                        <span>üì•</span> Exportar PDF Legal
                    </button>
                </div>
            </div>
        </div>

        <div id="alert-container"></div>

        <div class="card" style="margin-bottom: var(--spacing-lg);">
            <div class="grid grid-cols-4">
                <div class="form-group">
                    <label class="form-label">Fecha Inicio</label>
                    <input type="date" id="startDate" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Fecha Fin</label>
                    <input type="date" id="endDate" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Empleado</label>
                    <select id="employeeSelect" class="form-select">
                        <option value="">Todos los empleados</option>
                    </select>
                </div>
                <div class="form-group" style="display: flex; align-items: flex-end;">
                    <button onclick="loadAttendance()" class="btn btn-primary" style="width: 100%;">üîç Filtrar</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Empleado</th>
                            <th>DNI</th>
                            <th>Ubicaci√≥n</th>
                            <th>Fecha</th>
                            <th>Hora</th>
                            <th>Evento</th>
                            <th>Dispositivo / IP</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceTable">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 2rem;">Use los filtros para buscar
                                registros</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script src="js/api.js"></script>
    <script src="js/branding.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="js/reports.js"></script>
    <script>
        if (!isAuthenticated()) window.location.href = 'index.html';

        // Pre-cargar fechas (mes actual)
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
        const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().split('T')[0];
        document.getElementById('startDate').value = firstDay;
        document.getElementById('endDate').value = lastDay;

        let currentLogs = [];

        async function init() {
            // Cargar empleados para el select
            const data = await employeesAPI.getAll({ limit: 1000 });
            if (data && data.employees) {
                const select = document.getElementById('employeeSelect');
                data.employees.forEach(e => {
                    const opt = document.createElement('option');
                    opt.value = e._id;
                    opt.textContent = e.full_name;
                    select.appendChild(opt);
                });
            }
            loadAttendance();
        }

        async function loadAttendance() {
            const date = document.getElementById('startDate').value;
            const employeeId = document.getElementById('employeeSelect').value;

            const params = {};
            if (date) params.date = date;
            if (employeeId) params.employee_id = employeeId;

            const logs = await attendanceAPI.getReport(params);
            
            // Calcular rango de fechas para vacaciones
            let vacationStartDate = params.start_date;
            let vacationEndDate = params.end_date;
            
            // Si no hay fechas de filtro pero hay logs, usar el rango de los logs
            if ((!vacationStartDate || !vacationEndDate) && logs && logs.length > 0) {
                const dates = logs.map(l => new Date(l.timestamp).toISOString().split('T')[0]);
                vacationStartDate = dates.reduce((min, d) => d < min ? d : min, dates[0]);
                vacationEndDate = dates.reduce((max, d) => d > max ? d : max, dates[0]);
            }
            
            // Enriquecer con vacaciones
            await enrichWithVacations(logs || [], vacationStartDate, vacationEndDate, params.employee_id);
            
            // Generar d√≠as de vacaciones sin fichajes
            const enrichedLogs = await generateVacationDays(logs || [], vacationStartDate, vacationEndDate, params.employee_id);
            
            currentLogs = enrichedLogs;
            renderTable(enrichedLogs);
        }

        async function enrichWithVacations(logs, startDate, endDate, employeeId) {
            // Determinar qu√© empleados consultar
            let employeeIds = [];
            
            if (employeeId) {
                employeeIds = [employeeId];
            } else {
                const logsEmployees = [...new Set(logs.map(l => l.employee_id).filter(Boolean))];
                if (logsEmployees.length > 0) {
                    employeeIds = logsEmployees;
                } else {
                    window.vacationsMap = {};
                    return;
                }
            }

            try {
                const allVacations = [];
                for (const empId of employeeIds) {
                    const vacations = await vacationsAPI.getAll({ employee_id: empId });
                    if (vacations && vacations.length > 0) {
                        const approved = vacations.filter(v => v.status === 'approved');
                        allVacations.push(...approved.map(v => ({ ...v, employee_id: empId })));
                    }
                }

                // Crear mapa de empleado + fecha -> informaci√≥n de vacaciones
                window.vacationsMap = {};
                allVacations.forEach(vac => {
                    const start = new Date(vac.start_date);
                    const end = new Date(vac.end_date);
                    
                    // Formatear fechas para mostrar
                    const startFormatted = start.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
                    const endFormatted = end.toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' });
                    const dateRange = `${startFormatted} - ${endFormatted}`;
                    
                    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                        const dateKey = d.toISOString().split('T')[0];
                        const mapKey = `${vac.employee_id}_${dateKey}`;
                        window.vacationsMap[mapKey] = {
                            hasVacation: true,
                            dateRange: dateRange,
                            startDate: vac.start_date,
                            endDate: vac.end_date
                        };
                    }
                });
            } catch (error) {
                console.error('Error cargando vacaciones:', error);
                window.vacationsMap = {};
            }
        }

        async function generateVacationDays(logs, startDate, endDate, employeeId) {
            if (!window.vacationsMap || Object.keys(window.vacationsMap).length === 0) {
                return logs;
            }

            // Si no hay rango de fechas, no generar d√≠as sint√©ticos
            if (!startDate || !endDate) {
                return logs;
            }

            const employeeCache = {};
            
            if (employeeId) {
                try {
                    const response = await fetch(`/api/employees/${employeeId}`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (response.ok) {
                        employeeCache[employeeId] = await response.json();
                    }
                } catch (error) {
                    console.error('Error obteniendo empleado:', error);
                }
            }

            const syntheticLogs = [];
            
            for (const [mapKey, vacationInfo] of Object.entries(window.vacationsMap)) {
                const [empId, dateISO] = mapKey.split('_');
                
                if (startDate && dateISO < startDate) continue;
                if (endDate && dateISO > endDate) continue;
                if (employeeId && empId !== employeeId) continue;
                
                const existingLog = logs.find(l => {
                    const logDate = new Date(l.timestamp).toISOString().split('T')[0];
                    return l.employee_id === empId && logDate === dateISO;
                });
                
                if (!existingLog) {
                    if (!employeeCache[empId]) {
                        try {
                            const response = await fetch(`/api/employees/${empId}`, {
                                headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                            });
                            if (response.ok) {
                                employeeCache[empId] = await response.json();
                            }
                        } catch (error) {
                            console.error('Error obteniendo empleado:', error);
                        }
                    }
                    
                    const employee = employeeCache[empId];
                    if (employee) {
                        syntheticLogs.push({
                            timestamp: new Date(dateISO + 'T12:00:00').toISOString(),
                            employee_id: empId,
                            full_name: employee.full_name,
                            dni: employee.dni,
                            location: employee.location || '-',
                            type: 'vacation',
                            isVacationDay: true
                        });
                    }
                }
            }
            
            return [...logs, ...syntheticLogs];
        }

        function renderTable(logs) {
            const tbody = document.getElementById('attendanceTable');
            if (!logs || logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem;">No se encontraron registros</td></tr>';
                return;
            }

            // Agrupar por Fecha -> Empleado ID
            const grouped = {};

            logs.forEach(log => {
                const dateKey = new Date(log.timestamp).toLocaleDateString('es-ES');
                const key = `${dateKey}_${log.dni || log.full_name}`;

                if (!grouped[key]) {
                    grouped[key] = {
                        date: dateKey,
                        dateISO: new Date(log.timestamp).toISOString().split('T')[0],
                        employee: log.full_name,
                        employee_id: log.employee_id,
                        dni: log.dni,
                        logs: []
                    };
                }
                grouped[key].logs.push(log);
            });

            const sortedKeys = Object.keys(grouped).sort((a, b) => {
                const dateA = new Date(grouped[a].dateISO);
                const dateB = new Date(grouped[b].dateISO);
                
                // Primero ordenar por fecha (descendente - m√°s reciente primero)
                if (dateB.getTime() !== dateA.getTime()) {
                    return dateB - dateA;
                }
                
                // Si es la misma fecha, ordenar por nombre de empleado (alfab√©tico)
                return grouped[a].employee.localeCompare(grouped[b].employee);
            });

            const emojis = { in: 'üü¢', out: 'üî¥', break_start: 'üü†', break_end: 'üîµ' };
            const labels = { in: 'Entrada', out: 'Salida', break_start: 'Descanso (Inicio)', break_end: 'Descanso (Fin)' };

            let html = '';
            sortedKeys.forEach((key, index) => {
                const group = grouped[key];
                group.logs.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                const rowId = `details-${index}`;
                
                // Verificar si tiene vacaciones
                const vacationKey = `${group.employee_id}_${group.dateISO}`;
                const vacationInfo = window.vacationsMap && window.vacationsMap[vacationKey];
                const hasVacation = vacationInfo && vacationInfo.hasVacation;
                
                // Crear badge de vacaciones con rango de fechas
                let vacationBadge = '';
                if (hasVacation) {
                    vacationBadge = `<span class="badge badge-warning" title="Vacaciones: ${vacationInfo.dateRange}" style="cursor: help;">VACACIONES (${vacationInfo.dateRange})</span>`;
                }

                html += `
                <tr class="group-header" onclick="toggleDetails('${rowId}')" style="cursor: pointer; background: rgba(255,255,255,0.02);">
                    <td>${group.date}</td>
                    <td><strong>${group.employee}</strong></td>
                    <td>${group.dni || '-'}</td>
                    <td colspan="3">
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            ${vacationBadge}
                            <span class="badge badge-info">${group.logs.length} registros</span>
                            <small style="color: var(--text-muted);">(Clic para ver detalles)</small>
                        </div>
                    </td>
                    <td style="text-align: right;">
                        <span id="icon-${rowId}">‚ñº</span>
                    </td>
                </tr>
                <tr id="${rowId}" style="display: none; background: rgba(0,0,0,0.2);">>
                    <td colspan="7" style="padding: 0;">
                        <div style="padding: 1rem 2rem;">
                            <table class="table" style="width: 100%; font-size: 0.9em;">
                                <thead>
                                    <tr>
                                        <th style="color: var(--primary-light);">Hora</th>
                                        <th style="color: var(--primary-light);">Tipo de Fichaje</th>
                                        <th style="color: var(--primary-light);">Ubicaci√≥n</th>
                                        <th style="color: var(--primary-light);">Dispositivo</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${group.logs.map(log => {
                    // Si es un d√≠a de vacaciones sin fichajes reales
                    if (log.isVacationDay) {
                        return `
                                        <tr>
                                            <td colspan="4" style="text-align: center; padding: 1rem; color: var(--warning);">
                                                <strong>Sin fichajes (Vacaciones: ${vacationInfo.dateRange})</strong>
                                            </td>
                                        </tr>
                                        `;
                    }
                    
                    const hasCoords = log && log.latitude != null && log.longitude != null;
                    const geoInfo = hasCoords
                        ? `<a href="https://www.google.com/maps?q=${log.latitude},${log.longitude}" target="_blank" style="color: var(--primary-light); text-decoration: none;">üìç Ver Mapa</a>`
                        : '';

                    const storeName = (log && log.store_name) ? String(log.store_name).trim() : '';
                    const locationCell = storeName
                        ? `${storeName}${geoInfo ? `<div style=\"margin-top: 0.25rem;\">${geoInfo}</div>` : ''}`
                        : (geoInfo || 'Sin ubicaci√≥n');

                    return `
                                        <tr>
                                            <td style="font-family: monospace; font-weight: 600; width: 100px;">
                                                ${new Date(log.timestamp).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}
                                            </td>
                                            <td>
                                                <span class="badge badge-${log.type === 'in' ? 'success' : log.type === 'out' ? 'danger' : 'warning'}">
                                                    ${emojis[log.type]} ${labels[log.type]}
                                                </span>
                                            </td>
                                            <td>${locationCell}</td>
                                            <td style="color: var(--text-muted); font-size: 0.8em;">${log.device_info || '-'}</td>
                                        </tr>
                                        `;
                }).join('')}
                                </tbody>
                            </table>
                        </div>
                    </td>
                </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        function toggleDetails(id) {
            const row = document.getElementById(id);
            const icon = document.getElementById(`icon-${id}`);
            if (row.style.display === 'none') {
                row.style.display = 'table-row';
                if (icon) icon.textContent = '‚ñ≤';
            } else {
                row.style.display = 'none';
                if (icon) icon.textContent = '‚ñº';
            }
        }

        function exportAttendancePDF() {
            if (!currentLogs || currentLogs.length === 0) return showAlert('No hay datos para exportar', 'warning');

            // Preparar agrupaci√≥n para el helper
            const grouped = {};
            currentLogs.forEach(log => {
                const dateKey = new Date(log.timestamp).toLocaleDateString('es-ES');
                const key = `${dateKey}_${log.dni || log.full_name}`;
                if (!grouped[key]) {
                    grouped[key] = {
                        date: dateKey,
                        dateISO: new Date(log.timestamp).toISOString().split('T')[0],
                        employee: log.full_name,
                        employee_id: log.employee_id,
                        dni: log.dni,
                        location: log.location || '-',
                        logs: []
                    };
                }
                grouped[key].logs.push(log);
            });

            reportsUtil.exportGroupedAttendancePDF(
                'REGISTRO DIARIO DE JORNADA (Real Decreto-ley 8/2019)',
                grouped,
                'Registro_Jornada_Detallado'
            );
        }

        init();
    </script>
</body>

</html>